<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="7rNl1pYDf8PG1zHT1pYUggSuxR6o2lBYuz__hjKgC8U" />
  <meta name="description"
    content="Join the Pazhassiraja College Fine Arts celebration at Pulpally (PRC). Discover talent, creativity, and unforgettable artistic experiences organized by the PRC Union.">
  <meta name="keywords"
    content="Pazhassiraja College Fine Arts, College Arts Day, Pulpally, PRC Union, Arts Festival, Student Talent, Wayanad College Events, Arts and Culture, PRC Pulpally">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://unionartsprc.web.app/">
  <meta name="google-site-verification" content="qtFsvqbENnG317f0K3yIj3pI7aIG_CMqdm23kloUDzg" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/favicon-square.png" sizes="512x512">
  <link rel="icon" type="image/png" href="/assets/favicon-square.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="/assets/favicon-square.png">

  <!-- Site Name for Google Search -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Pazhassiraja College Fine Arts",
      "alternateName": ["PRC Fine Arts", "College Arts Day", "Union Arts PRC"],
      "url": "https://unionartsprc.web.app/"
    }
  </script>

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://unionartsprc.web.app/">
  <meta property="og:title" content="Pazhassiraja College Fine Arts">
  <meta property="og:description"
    content="Celebrate creativity and talent at the Pazhassiraja College Fine Arts Festival.">
  <meta property="og:image" content="assets/Pazhassiraja_College_Pulpally_Logo.png">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://unionartsprc.web.app/">
  <meta property="twitter:title" content="Pazhassiraja College Fine Arts">
  <meta property="twitter:description"
    content="Celebrate creativity and talent at the Pazhassiraja College Fine Arts Festival.">
  <meta property="twitter:image" content="assets/Pazhassiraja_College_Pulpally_Logo.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700;800&family=Playfair+Display:wght@700&family=Montserrat:wght@700&family=Rozha+One&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <title>Pazhassiraja College Fine Arts | PRC Union</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    :root {
      --bg-color: #050a14;
      --card-bg: rgba(20, 25, 40, 0.6);
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --accent-color: #8b5cf6;
      --accent-hover: #7c3aed;
      --gradient-main: linear-gradient(135deg, #6366f1, #8b5cf6);

      --font-heading: 'Outfit', sans-serif;
      --font-hero: 'Playfair Display', serif;
      --font-body: 'Inter', sans-serif;
      --input-bg: rgba(255, 255, 255, 0.03);
      --input-border: rgba(255, 255, 255, 0.1);
      --input-focus: rgba(139, 92, 246, 0.3);
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      scrollbar-color: rgba(217, 70, 239, 0.5) rgba(0, 0, 0, 0.3);
      /* Artistic Noise/Texture optional - kept clean for now */
    }



    /* Custom Scrollbar Styling */
    body::-webkit-scrollbar {
      width: 12px;
    }

    body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
    }

    body::-webkit-scrollbar-thumb {
      background: rgba(217, 70, 239, 0.5);
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    body::-webkit-scrollbar-thumb:hover {
      background: rgba(217, 70, 239, 0.7);
    }

    /* Ambient Background blobs */
    body::before,
    body::after {
      content: '';
      position: fixed;
      width: 50vw;
      height: 50vw;
      border-radius: 50%;
      filter: blur(80px);
      /* Soft glow */
      z-index: -1;
      opacity: 0.4;
      animation: float 20s infinite alternate ease-in-out;
    }

    body::before {
      top: -10%;
      left: -10%;
      background: radial-gradient(circle, #7c3aed, transparent);
    }

    body::after {
      bottom: -10%;
      right: -10%;
      background: radial-gradient(circle, #db2777, transparent);
      animation-delay: -10s;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0) scale(1);
      }

      100% {
        transform: translate(30px, 50px) scale(1.1);
      }
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes rotate-center {
      from {
        transform: translateX(-50%) rotate(0deg);
      }

      to {
        transform: translateX(-50%) rotate(360deg);
      }
    }

    /* Fixed Background Decorations */
    .mandala-decoration {
      position: fixed;
      z-index: -1;
      pointer-events: none;
      opacity: 0.08;
      color: var(--accent-color);
      width: 600px;
      height: 600px;
      animation: rotate 60s linear infinite;
    }

    .mandala-top-right {
      top: -150px;
      right: -150px;
    }

    .mandala-bottom-left {
      bottom: -150px;
      left: -150px;
      animation-direction: reverse;
    }

    /* Additional positions if needed */
    .mandala-top-left {
      top: -10%;
      left: -10%;
    }

    .mandala-center-right {
      top: 40%;
      right: -15%;
      animation-duration: 45s;
    }

    .mandala-bottom-center {
      bottom: -20%;
      left: 50%;
      transform: translateX(-50%);
      animation: rotate-center 80s linear infinite;
    }

    header {
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      box-sizing: border-box;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .logo {
      font-family: var(--font-heading);
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(to right, #f472b6, #a78bfa, #db2777);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(167, 139, 250, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo img {
      height: 45px;
      width: auto;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      margin-left: 2rem;
      font-family: var(--font-heading);
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.3s;
      position: relative;
    }

    nav a:hover {
      color: white;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .admin-btn {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .admin-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent-color);
    }

    main {
      padding: 6rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }

    /* Hero Section Styles */
    .hero-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4rem 1rem;
      position: relative;
      z-index: 10;
    }

    .hero-title {
      font-family: var(--font-hero);
      font-size: 5rem;
      font-weight: 700;
      color: white;
      margin: 0 0 1rem;
      letter-spacing: -0.02em;
      line-height: 1.1;
      text-shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
      animation: fadeScaleIn 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .hero-subtitle {
      font-family: var(--font-heading);
      font-size: 1rem;
      font-weight: 600;
      color: #cbd5e1;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      margin: 0 0 1.5rem;
      opacity: 0;
      animation: fadeInUp 1s 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .hero-tagline {
      font-size: 1.1rem;
      color: #94a3b8;
      max-width: 500px;
      margin: 0 auto 3rem;
      line-height: 1.6;
      opacity: 0;
      animation: fadeInUp 1s 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .hero-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 320px;
      opacity: 0;
      animation: fadeInUp 1s 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .hero-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      font-family: var(--font-heading);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .primary-btn {
      background: white;
      color: #0f172a;
      border: none;
      box-shadow: 0 10px 25px -5px rgba(255, 255, 255, 0.1);
    }

    .primary-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px -5px rgba(255, 255, 255, 0.2);
    }

    .secondary-btn {
      background: transparent;
      color: #64748b;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .closed-btn {
      cursor: not-allowed;
      opacity: 0.8;
      font-size: 0.85rem;
    }

    .authority-text {
      margin-top: 4rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0;
      animation: fadeIn 1.5s 1.2s forwards;
    }

    @keyframes fadeScaleIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .hero-title {
        font-size: 3.5rem;
      }
    }

    /* h1.logo-title span {
      display: inline-block;
    } */

    /* Remove old mobile-break if unused, or keep for compatibility */
    .mobile-break {
      display: block;
      /* Always stack now */
    }

    .mobile-break {
      display: none;
    }

    @keyframes shine {
      to {
        background-position: 200% center;
      }
    }

    @keyframes drop-in {
      from {
        transform: translateY(-15px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes float-heading {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    @media (max-width: 768px) {
      h1.logo-title {
        font-size: 3.8rem;
        /* Scaled for mobile */
        line-height: 0.9;
        letter-spacing: -1px;
        text-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }

      .mobile-break {
        display: block;
      }

      .logo {
        font-size: 1.1rem;
        max-width: 200px;
        line-height: 1.2;
      }

      header {
        padding: 1rem 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      nav a {
        margin-left: 1rem;
        font-size: 0.9rem;
      }

      main {
        padding: 1.5rem 1rem 4rem;
      }

      .hero-decorations {
        height: 30px;
        margin-bottom: 0.5rem;
      }

      /* Mobile Auth Optimizations */
      #auth-overlay {
        padding: 2rem 1rem 4rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .auth-card {
        padding: 2rem 1.25rem 3.5rem 1.25rem;
        border-radius: 1.25rem;
        border: none !important;
        box-shadow:
          0 25px 50px -12px rgba(0, 0, 0, 0.7),
          0 0 20px 2px rgba(217, 70, 239, 0.1),
          0 0 1px 1px rgba(255, 255, 255, 0.1) inset;
      }

      .auth-card h2 {
        font-size: 1.5rem;
      }

      .auth-card .logo img {
        height: 50px;
      }

      .auth-card .logo {
        max-width: none;
        width: 100%;
        justify-content: center;
      }

      /* Mobile Decorations - Reduced Opacity & Better Positioning */
      .mandala-decoration {
        opacity: 0.05 !important;
        /* Significantly reduced opacity for cleaner look */
        width: 300px;
        /* Smaller base size */
        height: 300px;
      }

      .mandala-top-right {
        top: -60px;
        right: -60px;
        width: 300px;
        height: 300px;
      }

      .mandala-bottom-left {
        bottom: -60px;
        left: -60px;
        width: 250px;
        height: 250px;
      }

      .mandala-top-left {
        top: 0;
        left: -80px;
        width: 200px;
        height: 200px;
      }

      .mandala-center-right {
        top: 45%;
        right: -80px;
        width: 250px;
        height: 250px;
      }

      .mandala-bottom-center {
        bottom: -20%;
        width: 400px;
        height: 400px;
      }
    }

    /* Collapsible About Section */
    #about {
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
      padding: 2rem !important;
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    #about:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    #about-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0, 1, 0, 1);
      opacity: 0;
    }

    #about.expanded #about-content {
      max-height: 1000px;
      transition: max-height 0.8s ease-in-out;
      opacity: 1;
      margin-top: 1.5rem;
    }

    .toggle-icon {
      font-size: 0.8rem;
      transition: transform 0.3s ease;
      display: inline-block;
      vertical-align: middle;
      margin-left: 0.5rem;
      color: var(--accent-color);
    }

    #about.expanded .toggle-icon {
      transform: rotate(180deg);
    }

    p.hero-text {
      font-size: 1.35rem;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto 3rem;
      font-weight: 300;
      line-height: 1.6;
    }

    .cta-btn {
      background: var(--gradient-main);
      color: white;
      padding: 1rem 3rem;
      border-radius: 3rem;
      text-decoration: none;
      font-weight: 700;
      font-family: var(--font-heading);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
      box-shadow: 0 10px 20px -10px rgba(244, 63, 94, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .cta-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 20px 30px -10px rgba(244, 63, 94, 0.6);
      filter: brightness(1.1);
    }

    /* Event Cards */
    /* Hero Decorations - Stardust */
    .hero-decorations {
      height: 60px;
      width: 100%;
      position: relative;
      margin-bottom: 1rem;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0;
      filter: blur(1px);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      animation: float-stardust 10s infinite ease-in-out;
    }

    .p1 {
      width: 4px;
      height: 4px;
      left: 20%;
      animation-delay: 0s;
    }

    .p2 {
      width: 3px;
      height: 3px;
      left: 40%;
      animation-delay: 2s;
    }

    .p3 {
      width: 5px;
      height: 5px;
      left: 60%;
      animation-delay: 4s;
    }

    .p4 {
      width: 2px;
      height: 2px;
      left: 80%;
      animation-delay: 1s;
    }

    .p5 {
      width: 4px;
      height: 4px;
      left: 35%;
      animation-delay: 6s;
    }

    .p6 {
      width: 3px;
      height: 3px;
      left: 75%;
      animation-delay: 3s;
    }

    @keyframes float-stardust {
      0% {
        transform: translateY(20px) scale(0);
        opacity: 0;
      }

      20% {
        opacity: 0.6;
      }

      50% {
        transform: translateY(-20px) translateX(15px) scale(1.2);
        opacity: 0.3;
      }

      80% {
        opacity: 0.6;
      }

      100% {
        transform: translateY(-40px) translateX(-10px) scale(0);
        opacity: 0;
      }
    }

    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2.5rem;
      margin-top: 6rem;
      text-align: left;
    }

    .event-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .event-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #f43f5e, #8b5cf6);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .event-card:hover {
      transform: translateY(-10px);
      background: rgba(30, 41, 59, 0.6);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
    }

    .event-card:hover::before {
      opacity: 1;
    }

    .event-date {
      color: #f472b6;
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
      display: block;
      font-family: var(--font-heading);
    }

    .event-title {
      font-family: var(--font-heading);
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: white;
    }

    .event-desc {
      color: var(--text-secondary);
      font-size: 1rem;
      line-height: 1.6;
    }

    /* Loading / Login Overlay - Updated to match new theme */
    #auth-overlay {
      background: var(--bg-color);
    }

    /* Re-using same style for Modal as cards */
    .auth-container {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(30px);
      border: none;
      box-shadow: 0 40px 80px -15px rgba(0, 0, 0, 0.8);
      padding: 3rem 2.5rem;
      border-radius: 2rem;
    }

    /* Modal Specific Scrollbar */
    .auth-container::-webkit-scrollbar {
      width: 6px;
    }


    .auth-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      margin: 1rem 0.5rem;
      border-radius: 10px;
    }

    .auth-container::-webkit-scrollbar-thumb {
      background: rgba(217, 70, 239, 0.2);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .auth-container::-webkit-scrollbar-thumb:hover {
      background: rgba(217, 70, 239, 0.5);
    }

    .auth-container {
      scrollbar-width: thin;
      scrollbar-color: rgba(217, 70, 239, 0.2) transparent;
      scroll-padding: 1rem;
    }

    /* Achievement Badges */
    .achievement-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5;
      white-space: nowrap;
      animation: badgePulse 2s infinite ease-in-out;
    }

    .achievement-badge.first {
      background: linear-gradient(135deg, #ffd700, #b8860b);
      color: #000;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .achievement-badge.second {
      background: linear-gradient(135deg, #e5e7eb, #9ca3af);
      color: #000;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .achievement-badge.third {
      background: linear-gradient(135deg, #d97706, #92400e);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes badgePulse {

      0%,
      100% {
        transform: scale(1);
        filter: brightness(1);
      }

      50% {
        transform: scale(1.05);
        filter: brightness(1.2);
      }
    }

    /* Form Styles */

    .form-input {
      width: 100%;
      padding: 0.875rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      /* Slightly lighter background */
      color: white;
      font-family: var(--font-body);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 15px var(--input-focus);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .custom-dropdown-container {
      position: relative;
      width: 100%;
      font-family: inherit;
    }

    .custom-dropdown-trigger {
      padding: 0.875rem;
      border-radius: 0.75rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: rgba(255, 255, 255, 0.6);
      /* Placeholder color by default */
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: all 0.3s ease;
    }

    .custom-dropdown-trigger:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .custom-dropdown-trigger.active {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent-color);
      box-shadow: 0 0 15px var(--input-focus);
      color: white;
    }

    .custom-dropdown-trigger.has-value {
      color: white;
      font-weight: 500;
    }

    .custom-dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 100%;
      background: #1e293b;
      /* Solid fallback */
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--input-border);
      border-radius: 0.75rem;
      z-index: 2000;
      /* Higher than inputs */
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      /* Animation handled by JS class */
    }

    .custom-dropdown-menu.show {
      display: block;
      animation: slideUp 0.2s ease-out;
    }

    /* Dropdown - Enhanced */
    .custom-dropdown-trigger {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .custom-dropdown-trigger:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .custom-dropdown-menu {
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    /* Dropdown Menu Scrollbar */
    .custom-dropdown-menu::-webkit-scrollbar {
      width: 8px;
    }

    .custom-dropdown-menu::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .custom-dropdown-menu::-webkit-scrollbar-thumb {
      background: rgba(217, 70, 239, 0.3);
      border-radius: 10px;
    }

    .custom-dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: rgba(217, 70, 239, 0.6);
    }

    .custom-dropdown-menu {
      scrollbar-width: thin;
      scrollbar-color: rgba(217, 70, 239, 0.5) rgba(0, 0, 0, 0.2);
    }

    .custom-dropdown-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      border-radius: 0.5rem;
      margin: 0.25rem;
    }

    .custom-dropdown-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(5px);
    }

    .custom-dropdown-group-label {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--accent-color);
      font-weight: 700;
      letter-spacing: 0.05em;
      pointer-events: none;
      margin-top: 0.5rem;
    }

    /* Dropdown Arrow Animation */
    .custom-dropdown-arrow {
      transition: transform 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .custom-dropdown-trigger.active .custom-dropdown-arrow {
      transform: rotate(180deg);
    }

    .hidden {
      display: none !important;
    }

    /* Ultra-Compact Branding-First Eye-Catchy Login UI */
    #auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #020617;
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      overflow: hidden;
    }

    #auth-overlay::before,
    #auth-overlay::after {
      content: '';
      position: absolute;
      width: 130vw;
      height: 130vw;
      border-radius: 50%;
      filter: blur(140px);
      z-index: -1;
      opacity: 0.15;
      animation: authGlaze 25s infinite alternate ease-in-out;
    }

    #auth-overlay::before {
      top: -40%;
      left: -30%;
      background: radial-gradient(circle, #4f46e5, #9333ea, transparent 70%);
    }

    #auth-overlay::after {
      bottom: -40%;
      right: -30%;
      background: radial-gradient(circle, #f59e0b, #dc2626, transparent 70%);
      animation-delay: -12s;
    }

    @keyframes authGlaze {
      0% {
        transform: translate(-5%, -5%) scale(1) rotate(0deg);
      }

      100% {
        transform: translate(5%, 5%) scale(1.1) rotate(15deg);
      }
    }

    .flip-card {
      width: 100%;
      max-width: 440px;
      height: 600px;
      /* Further reduced for ultra-compatibility */
      /* perspective: 3000px; */
      /* animation: cardHover 8s infinite ease-in-out; */
    }

    /* @keyframes cardHover {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    } */

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(-180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border-radius: 3rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .flip-card-front {
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      background: rgba(15, 23, 42, 0.82);
      border: none;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.7),
        0 0 20px 2px rgba(217, 70, 239, 0.1),
        0 0 1px 1px rgba(255, 255, 255, 0.1) inset;
    }

    .flip-card-back {
      padding: 2rem;
      transform: rotateY(-180deg);
      background: transparent;
    }

    .auth-card {
      padding: 2.25rem 2.25rem 2rem;
      /* Ultra-tight padding */
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .auth-badge {
      padding: 0.4rem 1.25rem;
      background: linear-gradient(135deg, #a855f7, #ec4899);
      color: white;
      border-radius: 2rem;
      font-size: 0.6rem;
      font-weight: 900;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 2rem;
      box-shadow: 0 10px 20px -5px rgba(236, 72, 153, 0.4);
    }

    .auth-card .logo {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .auth-card .logo img {
      height: 65px;
      /* Compact logo */
      filter: drop-shadow(0 0 25px rgba(236, 72, 153, 0.2));
    }

    .brand-hero-title {
      font-size: 1.4rem;
      font-weight: 900;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #d946ef 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      line-height: 1.1;
    }

    .auth-card h2 {
      font-size: 2.2rem;
      font-weight: 900;
      margin-bottom: 0.25rem;
      color: #fff;
      letter-spacing: -0.04em;
    }

    .auth-card p {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #94a3b8;
      margin-bottom: 2rem;
      /* Reduced margin */
      max-width: 300px;
      font-weight: 500;
    }

    .btn-super-eye-catchy {
      width: 100%;
      background: #fff;
      color: #0f172a;
      border: none;
      padding: 1.1rem;
      border-radius: 1.25rem;
      font-weight: 900;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      cursor: pointer;
      /* transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); */
      box-shadow: 0 12px 25px -5px rgba(255, 255, 255, 0.15);
    }

    /* .btn-super-eye-catchy:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 35px -8px rgba(255, 255, 255, 0.25);
    } */

    .btn-vibrant-glass {
      margin-top: 0.75rem;
      width: 100%;
      background: rgba(255, 255, 255, 0.03);
      border: 1.5px solid rgba(255, 255, 255, 0.06);
      color: #94a3b8;
      padding: 0.9rem;
      border-radius: 1.25rem;
      font-weight: 700;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      cursor: pointer;
      /* transition: all 0.3s ease; */
      text-transform: uppercase;
      backdrop-filter: blur(8px);
    }

    /* .btn-vibrant-glass:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      color: white;
    } */

    .auth-brand-footer {
      margin-top: auto;
      font-size: 0.55rem;
      font-weight: 900;
      letter-spacing: 0.4em;
      color: rgba(255, 255, 255, 0.15);
      text-transform: uppercase;
      padding-bottom: 0.5rem;
    }

    /* Leaderboard Refinements */
    .live-status-badge {
      position: relative;
    }

    .live-pulse {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      padding: 0.85rem 1rem;
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      gap: 1rem;
      cursor: pointer;
      /* transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
      animation: slideInRank 0.5s ease-out forwards;
      opacity: 0;
      transform: translateX(-10px);
    }

    /* .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateX(5px) scale(1.02);
    } */

    @keyframes slideInRank {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .rank-number {
      font-family: var(--font-heading);
      font-weight: 800;
      font-size: 1rem;
      min-width: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rank-1 {
      background: rgba(255, 215, 0, 0.1) !important;
      border-color: rgba(255, 215, 0, 0.3) !important;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);
    }

    .rank-1 .rank-number {
      color: #ffd700;
      font-size: 1.2rem;
    }

    .rank-2 {
      background: rgba(192, 192, 192, 0.08) !important;
      border-color: rgba(192, 192, 192, 0.25) !important;
    }

    .rank-2 .rank-number {
      color: #e2e8f0;
    }

    .rank-3 {
      background: rgba(205, 127, 50, 0.08) !important;
      border-color: rgba(205, 127, 50, 0.25) !important;
    }

    .rank-3 .rank-number {
      color: #f97316;
    }

    .dept-name {
      flex: 1;
      font-weight: 600;
      font-size: 0.85rem;
      line-height: 1.2;
      color: #cbd5e1;
      text-align: left;
    }

    .rank-1 .dept-name {
      color: #fff;
      font-weight: 700;
    }

    .score-value {
      font-family: var(--font-heading);
      font-weight: 900;
      font-size: 1.25rem;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .rank-1 .score-value {
      background: linear-gradient(to right, #ffd700, #facc15);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Skeleton Loading */
    .skeleton-loader {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      width: 100%;
    }

    .skeleton-item {
      height: 60px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 1rem;
      position: relative;
      overflow: hidden;
    }

    .skeleton-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      animation: loading-shimmer 1.5s infinite;
    }

    @keyframes loading-shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .swipe-badge {
      font-size: 0.65rem;
      color: #a5b4fc;
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.4;
      animation: nudge 4s infinite ease-in-out;
    }

    /* Leaderboard Responsive Classes */
    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 3.5rem;
    }

    .leaderboard-title {
      font-size: 2.8rem;
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #fff;
      font-weight: 900;
    }

    @keyframes nudge {

      0%,
      100% {
        transform: translateX(0);
        opacity: 0.2;
      }

      50% {
        transform: translateX(-4px);
        opacity: 0.5;
      }
    }

    @media (max-width: 480px) {
      .flip-card {
        height: min(580px, 90vh);
      }

      .brand-hero-title {
        font-size: 1.25rem;
      }

      .auth-card h2 {
        font-size: 2rem;
      }

      .auth-card {
        padding: 1.5rem 1rem !important;
      }

      .auth-badge {
        margin-bottom: 1.5rem;
      }

      /* Mobile Leaderboard Optimizations */
      .leaderboard-header {
        margin-bottom: 1rem !important;
      }

      .leaderboard-title {
        font-size: 2rem;
        margin-bottom: 1rem;
      }

      .flip-card-back {
        padding: 0.5rem !important;
      }

      #auth-flip-card {
        height: min(580px, 90vh) !important;
      }

      .leaderboard-item {
        padding: 0.6rem 0.75rem !important;
        gap: 0.75rem !important;
      }

      .dept-name {
        font-size: 0.8rem !important;
      }

      .score-value {
        font-size: 1.1rem !important;
      }
    }

    /* Registration Guide Styles (Converted to Popup) */

    .guide-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 5000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
    }

    .guide-container.active {
      display: flex;
    }

    .guide-card {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 2rem;
      padding: 3rem 2.5rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .guide-card::-webkit-scrollbar {
      width: 8px;
    }

    .guide-card::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
    }

    .guide-card::-webkit-scrollbar-thumb {
      background: rgba(217, 70, 239, 0.3);
      border-radius: 10px;
      border: 2px solid rgba(15, 23, 42, 0.95);
    }

    .guide-card::-webkit-scrollbar-thumb:hover {
      background: rgba(217, 70, 239, 0.5);
    }

    @keyframes modalSlideUp {
      from {
        transform: translateY(30px) scale(0.95);
        opacity: 0;
      }

      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .guide-header {
      margin-bottom: 2rem;
      text-align: center;
    }

    .guide-header h2 {
      font-family: var(--font-heading);
      font-size: 2rem;
      margin: 0;
      background: linear-gradient(to right, #f472b6, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .guide-steps {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }

    .guide-step {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      padding: 1.5rem;
      border-radius: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .guide-step:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(217, 70, 239, 0.3);
      transform: translateX(5px);
    }

    .step-number {
      width: 36px;
      height: 36px;
      background: var(--gradient-main);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      flex-shrink: 0;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(244, 63, 94, 0.3);
    }

    .step-content {
      flex: 1;
    }

    .step-content h3 {
      font-family: var(--font-heading);
      font-size: 1.15rem;
      margin: 0 0 0.25rem 0;
      color: white;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .step-content p {
      margin: 0;
      color: #e2e8f0;
      font-size: 0.95rem;
      line-height: 1.6;
      font-weight: 400;
    }

    .guide-close-btn {
      margin-top: 2rem;
      width: 100%;
      padding: 1rem;
      border-radius: 1rem;
      background: var(--gradient-main);
      color: white;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-family: var(--font-heading);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.3s ease;
    }

    .guide-close-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 10px 20px -5px rgba(244, 63, 94, 0.4);
    }

    @media (max-width: 768px) {
      .guide-container {
        margin: 2rem auto;
      }

      .guide-card {
        padding: 1.5rem;
      }

      .guide-step {
        gap: 1rem;
        padding: 0.75rem;
      }

      .guide-step:hover {
        transform: none;
      }




      .hero-text {
        font-size: 1.1rem !important;
        margin-bottom: 2rem !important;
      }

      /* Desktop Nav Hide */
      header nav {
        display: none;
      }

      /* Hamburger Menu Toggle Display */
      .hamburger {
        display: flex !important;
      }
    }

    /* Hamburger Menu Button */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      z-index: 1000;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .hamburger:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent-color);
    }

    .hamburger span {
      display: block;
      width: 24px;
      height: 2px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* Hamburger Active State (X) */
    .hamburger.active span:nth-child(1) {
      transform: translateY(8px) rotate(45deg);
    }

    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger.active span:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg);
    }

    /* Mobile Navigation Drawer */
    .mobile-nav {
      position: fixed;
      top: 0;
      right: -100%;
      width: 80%;
      height: 100vh;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      z-index: 900;
      padding: 8rem 2rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .mobile-nav.active {
      right: 0;
    }

    .mobile-nav a {
      color: white;
      text-decoration: none;
      font-size: 1.5rem;
      font-family: var(--font-heading);
      font-weight: 700;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .mobile-nav a:hover {
      color: var(--accent-color);
      transform: translateX(10px);
    }

    /* Overlay for Mobile Nav */
    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 800;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .nav-overlay.active {
      display: block;
      opacity: 1;
    }

    /* General Overflow Fix */
    html,
    body {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Back to Top Button */
    .back-to-top {
      position: fixed;
      bottom: 2rem;
      right: 1.5rem;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
    }

    .back-to-top.visible {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .back-to-top:hover {
      background: var(--gradient-main);
      transform: translateY(-5px);
      box-shadow: 0 15px 35px -5px rgba(244, 63, 94, 0.5);
    }

    /* Footer Optimization */
    .site-footer {
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 6rem 2rem 0;
      margin-top: 8rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .site-footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 10%;
      right: 10%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(217, 70, 239, 0.3), transparent);
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap: 4rem;
      text-align: left;
    }

    .footer-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .footer-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-family: var(--font-heading);
      font-weight: 800;
      font-size: 1.25rem;
      letter-spacing: 0.05em;
      background: linear-gradient(to right, #ffffff, #cbd5e1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .footer-logo img {
      height: 40px;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
    }

    .footer-desc {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 0;
      opacity: 0.8;
      max-width: 320px;
    }

    .footer-heading {
      color: white;
      font-size: 1rem;
      font-weight: 700;
      font-family: var(--font-heading);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0;
      position: relative;
      display: inline-block;
    }

    .footer-heading::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 20px;
      height: 2px;
      background: var(--accent-color);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .footer-column:hover .footer-heading::after {
      width: 40px;
    }

    .footer-nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.4;
    }

    .contact-item i {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-color);
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .contact-item:hover {
      color: white;
      transform: translateX(5px);
    }

    .contact-item:hover i {
      background: rgba(217, 70, 239, 0.15);
      border-color: rgba(217, 70, 239, 0.4);
      box-shadow: 0 0 20px rgba(217, 70, 239, 0.2);
    }

    .footer-links-list a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .footer-links-list a:hover {
      color: white;
      transform: translateX(5px);
    }

    .footer-bottom {
      margin-top: 6rem;
      padding: 3rem 0;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
    }

    .footer-copyright {
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.85rem;
      margin: 0;
    }

    .footer-dev-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(255, 255, 255, 0.3);
    }

    .footer-dev-tag span {
      color: var(--accent-color);
      font-weight: 700;
      opacity: 0.8;
    }

    @media (max-width: 1024px) {
      .footer-content {
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
      }
    }

    @media (max-width: 768px) {
      .site-footer {
        padding: 4rem 1.5rem 0;
        margin-top: 6rem;
      }

      .footer-content {
        grid-template-columns: 1fr;
        text-align: left;
        gap: 2.5rem;
      }

      .footer-column {
        align-items: flex-start;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .footer-column:last-child {
        border-bottom: none;
      }

      .footer-desc {
        max-width: 100%;
        font-size: 0.9rem;
      }

      .footer-heading::after {
        left: 0;
        transform: none;
      }

      .footer-bottom {
        margin-top: 4rem;
        flex-direction: column;
        text-align: center;
        gap: 1.25rem;
        padding: 2.5rem 0 4rem;
      }

      .footer-copyright,
      .footer-dev-tag {
        font-size: 0.8rem;
      }
    }

    /* My Registrations Section Styles */
    .registration-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      padding: 1.75rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Official Footer Extras */
    .footer-addr {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .footer-social-bar {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .social-btn {
      width: 38px;
      height: 38px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
    }

    .social-btn:hover {
      background: var(--accent-color);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(217, 70, 239, 0.3);
      border-color: var(--accent-color);
    }

    .registration-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #f43f5e, #8b5cf6);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .registration-card:hover {
      transform: translateY(-5px);
      background: rgba(30, 41, 59, 0.6);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
    }

    .registration-card:hover::before {
      opacity: 1;
    }

    .reg-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.25rem;
      gap: 1rem;
    }

    .reg-student-name {
      font-family: var(--font-heading);
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      margin: 0;
      line-height: 1.3;
      flex: 1;
    }

    .reg-category-badge {
      padding: 0.35rem 0.85rem;
      border-radius: 2rem;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      border: 1px solid;
    }

    .reg-category-badge.on-stage {
      background: rgba(255, 153, 51, 0.1);
      color: #ff9933;
      border-color: rgba(255, 153, 51, 0.3);
    }

    .reg-category-badge.off-stage {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
      border-color: rgba(139, 92, 246, 0.3);
    }

    /* Chest Badge Index */
    .chest-badge-index {
      background: var(--gradient-main);
      color: white;
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 4px 10px rgba(217, 70, 239, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 4px;
    }

    .reg-card-details {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .reg-detail-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.9rem;
      align-items: baseline;
    }

    .reg-detail-label {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      flex-shrink: 0;
    }

    .reg-detail-value {
      color: white;
      font-weight: 600;
      text-align: right;
      word-break: break-word;
    }

    .reg-program-highlight {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.75rem;
      border-radius: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .reg-timestamp {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
      text-align: center;
    }

    .reg-empty-state {
      grid-column: 1 / -1;
      padding: 4rem 2rem;
      text-align: center;
    }

    .reg-empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .reg-empty-text {
      color: var(--text-secondary);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .reg-empty-subtext {
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.9rem;
    }

    /* Reg Filter Styles */
    .reg-filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      justify-content: center;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.02);
      padding: 1.5rem;
      border-radius: 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      z-index: 100;
    }

    .reg-filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      text-align: left;
      min-width: 200px;
    }

    .reg-filter-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
      .reg-filter-bar {
        flex-direction: column;
        align-items: stretch;
        padding: 1rem;
        margin-left: 1rem;
        margin-right: 1rem;
      }

      .reg-filter-group {
        min-width: 0;
      }

      #my-registrations h2 {
        font-size: 2rem !important;
      }

      #registrations-container {
        grid-template-columns: 1fr !important;
      }

      .registration-card {
        padding: 1.5rem;
      }

      .reg-student-name {
        font-size: 1.1rem;
      }

      .reg-detail-row {
        flex-direction: column;
        gap: 0.25rem;
      }

      .reg-detail-value {
        text-align: left;
      }

      .reg-detail-value {
        text-align: left;
      }

      /* Single Line Registration Counts for Mobile */
      .reg-counts {
        flex-wrap: nowrap !important;
        gap: 0.5rem !important;
        width: 100%;
        justify-content: center;
      }

      .reg-count-badge {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
        flex: 0 1 auto;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 4px;
      }
    }

    /* Interactive Badge Filters */
    .reg-count-badge {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      user-select: none;
    }

    .reg-count-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      filter: brightness(1.2);
    }

    .reg-count-badge:active {
      transform: translateY(0);
    }

    .reg-count-badge.active {
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      border-width: 2px !important;
      transform: scale(1.05);
      z-index: 10;
    }

    .reg-count-badge.dimmed {
      opacity: 0.4;
      filter: grayscale(0.5);
    }

    /* Communication Action Buttons */
    .reg-card-actions {
      display: none;
      /* Hidden by default */
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      animation: fadeInDown 0.3s ease-out;
    }

    .reg-card-actions.show {
      display: grid;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .reg-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      padding: 0.7rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-family: var(--font-heading);
      letter-spacing: 0.02em;
    }

    .reg-action-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      margin-top: 1rem;
      width: 100%;
      justify-content: center;
    }

    .reg-action-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: var(--accent-color);
    }

    .reg-action-toggle i {
      transition: transform 0.3s ease;
    }

    .reg-action-toggle.active i {
      transform: rotate(180deg);
    }

    .reg-action-btn.call-btn {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.2);
    }

    .reg-action-btn.call-btn:hover {
      background: #10b981;
      color: white;
      box-shadow: 0 8px 20px -4px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }

    .reg-action-btn.whatsapp-btn {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.2);
    }

    .reg-action-btn.whatsapp-btn:hover {
      background: #22c55e;
      color: white;
      box-shadow: 0 8px 20px -4px rgba(34, 197, 94, 0.4);
      transform: translateY(-2px);
    }

    @media (max-width: 480px) {
      .reg-card-actions {
        grid-template-columns: 1fr;
      }
    }

    /* View Result Button Styles */
    .view-result-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .view-result-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .view-result-btn.first {
      border-color: rgba(255, 215, 0, 0.5);
      color: #ffd700;
      background: rgba(255, 215, 0, 0.05);
    }

    .view-result-btn.second {
      border-color: rgba(192, 192, 192, 0.5);
      color: #c0c0c0;
      background: rgba(192, 192, 192, 0.05);
    }

    .view-result-btn.third {
      border-color: rgba(205, 127, 50, 0.5);
      color: #cd7f32;
      background: rgba(205, 127, 50, 0.05);
    }

    /* System Notifications & Toast Styles */
    #system-notifications {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 11000;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      pointer-events: none;
    }

    .toast-notification {
      pointer-events: auto;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-left: 4px solid var(--accent-color);
      padding: 1.25rem 1.5rem;
      border-radius: 1rem;
      color: white;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 300px;
      max-width: 450px;
      animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      transition: all 0.3s ease;
    }

    .toast-notification.error {
      border-left-color: #ef4444;
    }

    .toast-notification.warning {
      border-left-color: #f59e0b;
    }

    .toast-notification.success {
      border-left-color: #10b981;
    }

    .toast-notification.info {
      border-left-color: #3b82f6;
    }

    @keyframes toastIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 800;
      font-family: var(--font-heading);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .toast-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      font-size: 1rem;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: white;
    }

    .toast-action-btn {
      margin-top: 0.75rem;
      background: var(--gradient-main);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .toast-action-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.1);
      box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
    }

    /* Network Weak Overlay */
    #network-status-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #f59e0b;
      color: #000;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      z-index: 10001;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    @media (max-width: 768px) {
      #system-notifications {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
      }

      .toast-notification {
        min-width: 0;
        width: 100%;
      }
    }

    /* Leaderboard Item Styles - Missing previously */
    .leaderboard-item {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: slideUp 0.5s ease-out forwards;
      opacity: 0;
    }

    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .rank-number {
      font-family: var(--font-heading);
      font-weight: 800;
      font-size: 1.1rem;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      margin-right: 0.75rem;
      color: white;
    }

    .leaderboard-item.rank-1 .rank-number {
      background: linear-gradient(135deg, #ffd700, #b8860b);
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .leaderboard-item.rank-2 .rank-number {
      background: linear-gradient(135deg, #c0c0c0, #7f8c8d);
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3);
    }

    .leaderboard-item.rank-3 .rank-number {
      background: linear-gradient(135deg, #cd7f32, #8b4513);
      color: white;
    }

    .dept-name {
      flex: 1;
      font-weight: 600;
      font-size: 0.95rem;
      color: white;
      white-space: normal;
      /* Allow wrapping */
      line-height: 1.2;
    }

    .score-value {
      font-family: var(--font-heading);
      font-weight: 800;
      font-size: 1.1rem;
      background: var(--gradient-main);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }


    #auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #0f172a;
      /* Fallback */
      background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
    }

    #auth-overlay.hidden {
      display: none;
    }


    /* Auth Card (Desktop) - Missing previously */
    .auth-card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: none;
      border-radius: 2rem;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 450px;
      text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      margin: auto;
    }

    /* Input Fields in Auth Card */
    .auth-card input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-family: var(--font-body);
    }

    .auth-card h2 {
      margin-bottom: 0.5rem;
      font-family: var(--font-heading);
    }

    .auth-card p {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Leaderboard Flip Card Styles */
    .flip-card {
      background-color: transparent;
      perspective: 1000px;
      width: 100%;
      max-width: 450px;
      /* Default logic */
      height: 100%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: max-width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .flip-card.flipped {
      max-width: 600px;
      width: 90vw;
    }

    @media (max-width: 768px) {
      .flip-card.flipped {
        width: 95%;
        height: 85vh;
        /* Use more vertical space */
        max-width: none;
      }

      .flip-card-back .auth-card {
        padding: 1.5rem 1rem !important;
        /* Reduce padding to give content more room */
        padding-top: 2.5rem !important;
      }

      .flip-card-back h2 {
        font-size: 2rem !important;
        /* Scale down title */
        margin-bottom: 1rem !important;
      }

      .dept-name {
        font-size: 0.85rem;
        word-wrap: break-word;
      }
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.8s;
      transform-style: preserve-3d;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front {
      position: absolute;
      width: 100%;
      max-width: 450px;
      /* Constrain front face */
      height: auto;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .flip-card-back {
      position: absolute;
      width: 100%;
      /* Back face fills expanded container */
      height: auto;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      display: flex;
      justify-content: center;
      align-items: center;
      transform: rotateY(180deg);
    }

    /* Leaderboard Specific Styles (Back Side) */
    .flip-card-back .auth-card {
      background: rgba(30, 41, 59, 0.9);
      height: 100%;
      /* Fill the enlarged area */
      display: flex;
      flex-direction: column;
    }

    /* Vibrant Glass Button */
    .btn-vibrant-glass {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 2rem;
      font-weight: 700;
      cursor: pointer;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      font-family: var(--font-heading);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.8rem;
      margin-top: 1rem;
      width: 100%;
    }

    .btn-vibrant-glass:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* Super Eye Catchy Button (Google Sign In) */
    .btn-super-eye-catchy {
      background: white;
      color: #1a1a1a;
      border: none;
      padding: 1rem;
      border-radius: 2rem;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: var(--font-body);
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }

    .btn-super-eye-catchy:hover {
      transform: scale(1.02) translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .live-pulse {
      width: 8px;
      height: 8px;
      background-color: #ef4444;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .swipe-badge {
      display: none;
      /* Hide swipe hint on desktop */
      margin-top: 2rem;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      align-items: center;
      gap: 0.5rem;
      animation: bounce-x 2s infinite;
    }

    @media (max-width: 768px) {
      .swipe-badge {
        display: flex;
        justify-content: center;
      }
    }

    @keyframes bounce-x {

      0%,
      100% {
        transform: translateX(0);
      }

      50% {
        transform: translateX(5px);
      }
    }

    /* Entrance Animations */
    @keyframes fadeSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-card>* {
      opacity: 0;
      animation: fadeSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .auth-card>*:nth-child(1) {
      animation-delay: 0.1s;
    }

    .auth-card>*:nth-child(2) {
      animation-delay: 0.2s;
    }

    .auth-card>*:nth-child(3) {
      animation-delay: 0.3s;
    }

    .auth-card>*:nth-child(4) {
      animation-delay: 0.4s;
    }

    .auth-card>*:nth-child(5) {
      animation-delay: 0.5s;
    }

    .auth-card>*:nth-child(6) {
      animation-delay: 0.6s;
    }

    .auth-card>*:nth-child(7) {
      animation-delay: 0.7s;
    }

    /* Ensure footer elements are also animated */
    .auth-card .swipe-badge {
      animation-delay: 0.8s;
    }

    .auth-card .auth-brand-footer {
      animation-delay: 0.9s;
    }


    /* Enhanced Button Interactions */
    .btn-vibrant-glass:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--accent-color);
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 10px 25px rgba(217, 70, 239, 0.3);
    }

    .btn-super-eye-catchy:hover {
      transform: scale(1.03) translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    /* Cartoon Chase Animation */
    .cartoon-scene-container {
      position: relative;
      width: 260px;
      height: 80px;
      background: transparent;
      overflow: hidden;
      margin: 1rem auto;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .mouse-hole {
      position: absolute;
      bottom: 0;
      left: 80%;
      width: 30px;
      height: 40px;
      background: #0f172a;
      border-radius: 30px 30px 0 0;
      border: 2px solid rgba(255, 255, 255, 0.1);
      z-index: 1;
    }

    .jerry {
      position: absolute;
      bottom: 5px;
      left: -30px;
      font-size: 1rem;
      color: #eab308;
      z-index: 5;
      animation: jerryRun 6s linear infinite;
    }

    .tom {
      position: absolute;
      bottom: 5px;
      left: -60px;
      font-size: 2rem;
      color: #94a3b8;
      z-index: 6;
      animation: tomChase 6s linear infinite;
    }

    .cartoon-dust {
      position: absolute;
      bottom: 5px;
      left: 70%;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      opacity: 0;
      box-shadow: 10px -5px 0 rgba(255, 255, 255, 0.3), -5px -10px 0 rgba(255, 255, 255, 0.4);
      animation: dustCloud 6s linear infinite;
    }

    @keyframes jerryRun {
      0% {
        left: -30px;
        opacity: 1;
      }

      30% {
        left: 81%;
        opacity: 1;
        transform: scaleX(1);
      }

      /* Reach hole faster (30% of 6s = 1.8s) */
      32% {
        left: 81%;
        opacity: 0;
        transform: scaleX(1) scale(0.5);
      }

      100% {
        left: 81%;
        opacity: 0;
      }
    }

    @keyframes tomChase {
      0% {
        left: -80px;
        transform: scaleX(1);
      }

      33% {
        left: 72%;
        transform: scaleX(1);
      }

      /* Catch up in ~2s */
      38% {
        left: 72%;
        transform: skewX(-20deg) scaleX(1);
      }

      /* Skid */
      45% {
        left: 72%;
        transform: scaleX(1);
      }

      /* Recover */
      50% {
        left: 72%;
        transform: scaleX(-1);
      }

      /* Turn around */
      100% {
        left: -80px;
        transform: scaleX(-1);
      }

      /* Walk away slowly (3s duration) */
    }

    @keyframes dustCloud {

      0%,
      33% {
        opacity: 0;
        transform: scale(0.5);
      }

      38% {
        opacity: 1;
        transform: scale(1.5);
      }

      45% {
        opacity: 0;
        transform: scale(2);
      }

      100% {
        opacity: 0;
      }
    }

    /* Mobile Optimization for Cartoon Animation */
    /* Mobile Optimization for Cartoon Animation */
    @media (max-width: 480px) {
      .cartoon-scene-container {
        width: 100%;
        max-width: 260px;
        height: 70px;
        /* Increased slightly */
        background: rgba(255, 255, 255, 0.02);
        /* Faint bg for visibility */
      }

      .tom,
      .jerry {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .tom {
        font-size: 1.5rem;
        bottom: 10px;
      }

      /* Scale down */
      .jerry {
        font-size: 1rem;
        bottom: 15px;
        /* Lifted slightly */
      }

      .mouse-hole {
        height: 35px;
        width: 28px;
        left: 85%;
        /* Adjusted endpoint */
      }
    }

    /* Custom Alert Modal */
    #custom-alert-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 12000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .custom-alert-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 2rem;
      padding: 2.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 40px 80px -15px rgba(0, 0, 0, 0.8),
        0 0 1px 1px rgba(255, 255, 255, 0.1) inset;
      animation: alertSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes alertSlideUp {
      from {
        transform: translateY(30px) scale(0.9);
        opacity: 0;
      }

      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .custom-alert-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 1.5rem;
    }

    .custom-alert-icon.info {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .custom-alert-icon.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .custom-alert-title {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      font-weight: 800;
      color: white;
      margin-bottom: 0.75rem;
    }

    .custom-alert-message {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 2rem;
    }

    .custom-alert-btn {
      width: 100%;
      background: var(--gradient-main);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 1.25rem;
      font-weight: 800;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px -5px rgba(244, 63, 94, 0.4);
    }

    .custom-alert-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 15px 30px -5px rgba(244, 63, 94, 0.5);
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Outfit:wght@400;600;800&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

  <!-- Registration Guide Popup Overlay -->
  <div class="guide-container" id="reg-guide-modal">
    <div class="guide-card">
      <div class="guide-header">
        <h2>Registration Steps</h2>
      </div>
      <div class="guide-steps">
        <div class="guide-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h3>Choose Category</h3>
            <p>Click "Register For Events" or select "On Stage" / "Off Stage" cards.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h3>Basic Info</h3>
            <p>Enter student's full name (it will be uppercased).</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Academic Details</h3>
            <p>Select Department, Roll Number, and Year.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h3>Contact & Gender</h3>
            <p>Provide phone number and select gender.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="step-number">5</div>
          <div class="step-content">
            <h3>Pick Program</h3>
            <p>Choose the specific event or item.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="step-number">6</div>
          <div class="step-content">
            <h3>Success!</h3>
            <p>Complete registration and <strong>screenshot</strong> the result!</p>
          </div>
        </div>
      </div>
      <button class="guide-close-btn" id="close-guide-popup">Got it, Let's Go!</button>
    </div>
  </div>

  <!-- Mobile Nav Overlay -->
  <div class="nav-overlay" id="mobile-overlay"></div>

  <!-- Mobile Nav Drawer -->
  <div class="mobile-nav" id="mobile-drawer">
    <a href="#" class="mobile-link">Home</a>
    <a href="#about" class="mobile-link">About</a>
    <a href="#events" class="mobile-link">Events</a>
    <a href="/leaderboard" class="mobile-link">Leaderboard</a>
    <a href="/news/" class="mobile-link">News</a>
    <a href="#my-registrations" class="mobile-link">My Registrations</a>
    <a href="/appeal" class="mobile-link">Go for Appeal</a>
    <a href="javascript:void(0)" id="mobile-logout-btn"
      style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 1rem; opacity: 0.7;">Logout</a>
  </div>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="back-to-top" aria-label="Back to Top">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <!-- Floating Decorative Elements -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: -1;">
      <svg class="mandala-decoration"
        style="top: -5vw; right: -5vw; width: 45vw; height: 45vw; opacity: 0.2; fill: #4f46e5; animation: rotateSlow 70s linear infinite;"
        viewBox="0 0 200 200">
        <path
          d="M100 0C100 0 110 50 150 50C190 50 200 100 200 100C200 100 150 110 150 150C150 190 100 200 100 200C100 200 90 150 50 150C10 150 0 100 0 100C0 100 50 90 50 50C50 10 100 0 100 0Z" />
      </svg>
      <svg class="mandala-decoration"
        style="bottom: -10vw; left: -10vw; width: 55vw; height: 55vw; opacity: 0.15; fill: #f59e0b; animation: rotateSlow 90s linear reverse infinite;"
        viewBox="0 0 200 200">
        <path
          d="M100 0C100 0 110 50 150 50C190 50 200 100 200 100C200 100 150 110 150 150C150 190 100 200 100 200C100 200 90 150 50 150C10 150 0 100 0 100C0 100 50 90 50 50C50 10 100 0 100 0Z" />
      </svg>
    </div>

    <style>
      @keyframes rotateSlow {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }
    </style>

    <div class="flip-card" id="auth-flip-card">
      <div class="flip-card-inner">
        <!-- Front side (Login) -->
        <div class="flip-card-front">
          <div class="auth-card">
            <div class="auth-badge" id="auth-year-badge">Arts Fest 2025-26</div>

            <div class="logo">
              <img src="assets/Pazhassiraja_College_Pulpally_Logo.png" alt="College Logo">
            </div>

            <div class="brand-hero-title">College Union PRC</div>
            <h2>Sign In</h2>
            <p>Authorized access to the official departmental registration portal.</p>

            <button id="google-signin-btn" class="btn-super-eye-catchy">
              <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24">
                <path
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  fill="#4285F4" />
                <path
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  fill="#34A853" />
                <path
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"
                  fill="#FBBC05" />
                <path
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.66l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  fill="#EA4335" />
              </svg>
              Sign in with Google
            </button>

            <div id="auth-status" class="error-msg"></div>

            <button id="view-standings-btn" class="btn-vibrant-glass">
              Public Leaderboard
            </button>

            <div class="swipe-badge">
              <i class="fas fa-chevron-left"></i> Swipe for Scores
            </div>

            <div class="cartoon-scene-container">
              <div class="mouse-hole"></div>
              <div class="jerry"><i class="fas fa-otter"></i></div>
              <div class="tom"><i class="fas fa-cat"></i></div>
              <div class="cartoon-dust"></div>
            </div>

            <div class="auth-brand-footer">
              Authorized Personnel Only
            </div>
          </div>
        </div>

        <!-- Back side (Leaderboard) -->
        <div class="flip-card-back">
          <div class="auth-card"
            style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; text-align: center;">
            <div class="leaderboard-header">
              <div class="auth-badge live-status-badge"
                style="margin-bottom: 0; background: rgba(255, 255, 255, 0.15);">
                <span class="live-pulse"></span>
                Live Status
              </div>
              <button id="share-leaderboard-btn" title="Share"
                style="background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.2); color: #fff; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                <i class="fas fa-share-alt" style="font-size: 1.1rem;"></i>
              </button>
            </div>

            <div
              style="font-size: 1rem; color: #a5b4fc; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 0;">
              College Union PRC</div>
            <h2 class="leaderboard-title">
              Leaderboard
            </h2>

            <!-- Removed "Live Department Standings" Text -->

            <div id="public-leaderboard-content"
              style="flex: 1; overflow-y: auto; width: 100%; padding-right: 0.5rem; text-align: left; margin-bottom: 0.5rem;">
              <div class="skeleton-loader">
                <div class="skeleton-item"></div>
                <div class="skeleton-item" style="opacity: 0.8;"></div>
                <div class="skeleton-item" style="opacity: 0.6;"></div>
                <div class="skeleton-item" style="opacity: 0.4;"></div>
                <div class="skeleton-item" style="opacity: 0.2;"></div>
              </div>
            </div>

            <button id="back-to-login-btn" class="btn-vibrant-glass">
              Back to Login
            </button>

            <div class="swipe-badge">
              Swipe for Login <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  </div>
  </div>


  </div>
  </div>
  </div>


  <!-- Main Content (Wrapped) -->
  <div id="main-content" class="hidden">
    <header>
      <div class="logo">
        <img src="assets/Pazhassiraja_College_Pulpally_Logo.png" alt="College Logo">
        <div style="display: flex; flex-direction: column; line-height: 1.1;">
          <span style="font-size: 1.2rem; font-weight: 800;">COLLEGE UNION PRC</span>
        </div>
      </div>
      <nav>
        <a href="#">Home</a>
        <a href="#about">About</a>
        <a href="#events">Events</a>
        <a href="/leaderboard">Leaderboard</a>

        <a href="#my-registrations">My Registrations</a>
        <a href="/appeal">Go for Appeal</a>

        <a href="javascript:void(0)" id="logout-btn"
          style="color: var(--text-secondary); text-decoration: none; font-size: 0.8rem; opacity: 0.7;">Logout</a>
      </nav>

      <!-- Hamburger Menu (Mobile) -->
      <div class="hamburger" id="hamburger-menu">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </header>

    <main>
      <div class="hero-decorations">
        <div class="particle p1"></div>
        <div class="particle p2"></div>
        <div class="particle p3"></div>
        <div class="particle p4"></div>
        <div class="particle p5"></div>
        <div class="particle p6"></div>
      </div>
      <div class="hero-container">
        <h1 class="hero-title">NAVRANG ARTS</h1>
        <h2 class="hero-subtitle">ANNUAL COLLEGE ARTS FESTIVAL</h2>
        <p class="hero-tagline">Celebrate creativity, talent, and expression. Join the ultimate artistic journey.</p>

        <div class="hero-actions">
          <a href="javascript:void(0)" id="register-btn" class="hero-btn primary-btn">
            <i class="fas fa-edit"></i> Register Now
          </a>
          <a href="javascript:void(0)" id="leaderboard-btn" class="hero-btn secondary-btn">
            Leaderboard
          </a>
        </div>

        <div class="authority-text">Organised by College Union PRC</div>
      </div>

      <div id="events" class="events-grid">
        <!-- Event Cards -->
        <div class="event-card">
          <span class="event-date">Main Event</span>
          <div class="event-title">On Stage</div>
          <div class="event-desc">Experience electrifying music, captivating dance, and dramatic performances on the
            grand main stage.</div>
        </div>
        <div class="event-card">
          <span class="event-date">Competitions</span>
          <div class="event-title">Off Stage</div>
          <div class="event-desc">Showcase your skills in writing, painting, and other creative arts at dedicated venues
            across campus.</div>
        </div>
      </div>

      <section id="about" style="max-width: 800px; margin: 6rem auto 0; text-align: center;">
        <h2
          style="font-family: var(--font-heading); margin: 0; color: white; display: flex; align-items: center; justify-content: center;">
          About The Event <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
        </h2>
        <div id="about-content">
          <p style="color: var(--text-secondary); line-height: 1.8; font-size: 1.1rem; margin: 0;">
            The College Arts Day is the premier annual cultural festival organized by the College Union.
            Designed to foster creativity and excellence, this event brings together students from all departments
            to showcase their artistic talents in a celebration of culture and community.
          </p>
        </div>
      </section>

      <!-- My Registrations Section -->
      <section id="my-registrations" style="max-width: 1200px; margin: 6rem auto 0; text-align: center;">
        <h2 style="font-family: var(--font-heading); margin: 0 0 1rem 0; color: white; font-size: 2.5rem;">
          My Registrations
        </h2>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 1rem;">
          View all students you have registered for the event
        </p>

        <!-- Registration Counts -->
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 2rem;">
          <div class="reg-counts" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <div class="reg-count-badge on-stage" id="btn-filter-on-stage"
              style="background: rgba(255, 153, 51, 0.1); color: #ff9933; border: 1px solid rgba(255, 153, 51, 0.3); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; font-weight: 700;">
              On Stage: <span id="count-on-stage">0</span>
            </div>
            <div class="reg-count-badge off-stage" id="btn-filter-off-stage"
              style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; font-weight: 700;">
              Off Stage: <span id="count-off-stage">0</span>
            </div>
            <div class="reg-count-badge" id="count-total-badge"
              style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; font-weight: 700; cursor: default;">
              Total: <span id="count-filtered-total">0</span>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
            <button id="download-pdf-btn" onclick="openPDFPreview()"
              style="background: var(--gradient-main); color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 2rem; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);">
              <i class="fas fa-file-pdf"></i> Download PDF
            </button>
            <button id="results-summary-btn" onclick="showResultsSummary()"
              style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1e293b; border: none; padding: 0.5rem 1.25rem; border-radius: 2rem; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">
              <i class="fas fa-trophy"></i> Results
            </button>
            <a href="/appeal" id="go-to-appeal-btn"
              style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 0.5rem 1.25rem; border-radius: 2rem; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; text-decoration: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
              <i class="fas fa-gavel"></i> Go for Appeal
            </a>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="reg-filter-bar">
          <div class="reg-filter-group">
            <label class="reg-filter-label">Filter by Year</label>
            <div class="custom-dropdown-container">
              <input type="hidden" id="filter-reg-year" value="all">
              <div class="custom-dropdown-trigger" id="filter-year-trigger"
                style="box-sizing: border-box; width: 100%;">
                <span id="filter-year-text">All Years</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" id="filter-year-menu">
                <div class="custom-dropdown-item" data-value="all">All Years</div>
                <div class="custom-dropdown-item" data-value="1">1st Year</div>
                <div class="custom-dropdown-item" data-value="2">2nd Year</div>
                <div class="custom-dropdown-item" data-value="3">3rd Year</div>
                <div class="custom-dropdown-item" data-value="4">4th Year</div>
              </div>
            </div>
          </div>

          <div class="reg-filter-group">
            <label class="reg-filter-label">Filter by Course</label>
            <div class="custom-dropdown-container">
              <input type="hidden" id="filter-reg-department" value="">
              <div class="custom-dropdown-trigger" id="filter-dept-trigger"
                style="box-sizing: border-box; width: 100%;">
                <span id="filter-dept-text">All Courses</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" id="filter-dept-menu">
                <div class="custom-dropdown-item" data-value="">All Courses</div>
                <!-- Will be populated by JS -->
              </div>
            </div>
          </div>

          <div class="reg-filter-group">
            <label class="reg-filter-label">Filter by Item / Program</label>
            <div class="custom-dropdown-container">
              <input type="hidden" id="filter-reg-item" value="">
              <div class="custom-dropdown-trigger" id="filter-item-trigger"
                style="box-sizing: border-box; width: 100%;">
                <span id="filter-item-text">All Items</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" id="filter-item-menu">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <div class="reg-filter-group">
            <label class="reg-filter-label">Filter by Date of Item</label>
            <div class="custom-dropdown-container">
              <input type="hidden" id="filter-reg-date" value="all">
              <div class="custom-dropdown-trigger" id="filter-date-trigger"
                style="box-sizing: border-box; width: 100%;">
                <span id="filter-date-text">All Dates</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" id="filter-date-menu">
                <div class="custom-dropdown-item" data-value="all">All Dates</div>
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <div id="registrations-container"
          style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; text-align: left;">
          <!-- Registrations will be populated here by JavaScript -->
          <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; color: var(--text-secondary);">
            Loading registrations...
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-column">
          <div class="footer-logo">
            <img src="assets/Pazhassiraja_College_Pulpally_Logo.png" alt="College Logo">
            <span>UNION PRC</span>
          </div>
          <p class="footer-desc">
            The official arts event portal of Pazhassiraja College Pulpally. Empowering student creativity and fostering
            a vibrant cultural community.
          </p>
          <div class="contact-item" style="cursor: default; margin-top: 0.5rem;">
            <i class="fas fa-location-dot"></i>
            <span>Pazhassiraja College, Pulpally<br>Wayanad, Kerala - 673579</span>
          </div>
        </div>

        <div class="footer-column">
          <h4 class="footer-heading">Contact Us</h4>
          <div class="footer-nav-list">
            <a href="mailto:collageunionprc@gmail.com" class="contact-item">
              <i class="fas fa-envelope"></i>
              <span>collageunionprc@gmail.com</span>
            </a>
            <a href="tel:+918281430208" class="contact-item">
              <i class="fas fa-phone"></i>
              <span>+91 8281430208</span>
            </a>
          </div>
        </div>

        <div class="footer-column">
          <h4 class="footer-heading">Tech Support</h4>
          <div class="footer-nav-list">
            <a href="mailto:ashinmrelu@gmail.com" class="contact-item">
              <i class="fas fa-at"></i>
              <span>arshinmrelju@gmail.com</span>
            </a>
            <a href="https://www.instagram.com/arshin_m_relju" target="_blank" class="contact-item">
              <i class="fab fa-instagram"></i>
              <span>@arshin_m_relju</span>
            </a>
          </div>
        </div>

        <div class="footer-column">
          <h4 class="footer-heading">Portals</h4>
          <div class="footer-nav-list">
            <a href="/admin/" class="contact-item">
              <i class="fas fa-user-shield"></i>
              <span>Admin Portal</span>
            </a>
            <a href="/coreadmin/" class="contact-item">
              <i class="fas fa-microchip"></i>
              <span>Core Admin</span>
            </a>
            <a href="/stagemanager/" class="contact-item">
              <i class="fas fa-theater-masks"></i>
              <span>Stage Manager</span>
            </a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="footer-copyright">
          &copy; 2026 College Union PRC. All rights reserved.
        </div>

      </div>
    </footer>
  </div>

  <!-- Registration Modal -->
  <div id="reg-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div class="auth-container"
      style="max-width: 500px; width: 95%; position: relative; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto;">
      <button id="close-modal"
        style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>

      <h2 style="margin-top: 0; margin-bottom: 0.5rem; font-size: 1.75rem;">Registration</h2>
      <p id="modal-category"
        style="color: var(--accent-color); margin-bottom: 2rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.8rem; background: rgba(217, 70, 239, 0.1); padding: 0.4rem 1rem; border-radius: 2rem; display: inline-block; border: 1px solid rgba(217, 70, 239, 0.2);">
        Category</p>

      <form id="reg-form" style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">

        <!-- Registration Type (Only for On Stage) -->
        <div id="reg-type-container" class="hidden">
          <label
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Registration
            Type</label>
          <div class="custom-dropdown-container">
            <input type="hidden" id="reg-type" value="Individual">
            <div class="custom-dropdown-trigger has-value" id="type-trigger" style="box-sizing: border-box;">
              <span id="type-selected-text">Individual</span>
              <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="custom-dropdown-menu" id="type-menu">
              <div class="custom-dropdown-item" data-value="Individual">Individual</div>
              <div class="custom-dropdown-item" data-value="Group">Group</div>
            </div>
          </div>
        </div>

        <!-- Group Name (Hidden by default) -->
        <div id="group-name-container" class="hidden">
          <label for="reg-group-name"
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Group
            Name</label>
          <input type="text" id="reg-group-name" placeholder="e.g. MARGAMKALI ENGLISH" class="form-input"
            style="box-sizing: border-box; text-transform: uppercase;">
        </div>

        <div>
          <label for="reg-name" id="reg-name-label"
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Full
            Name</label>
          <input type="text" id="reg-name" placeholder="e.g. JOHN DOE" required class="form-input"
            style="box-sizing: border-box; text-transform: uppercase;">
        </div>

        <!-- Group Members Section (Hidden by default) -->
        <div id="group-members-container" class="hidden"
          style="margin-top: 0.5rem; border: 1px solid rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 1rem; background: rgba(15, 23, 42, 0.2);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <label
              style="display: block; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Group
              Members <span style="color: var(--error);">*</span></label>
            <span id="member-count" style="font-size: 0.7rem; color: var(--text-muted);">0 Members</span>
          </div>
          <div id="members-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
            <!-- Dynamic members will be added here -->
          </div>
          <button type="button" id="add-member-btn" class="form-input"
            style="margin-top: 1rem; background: rgba(217, 70, 239, 0.05); color: var(--accent-secondary); border: 1px dashed rgba(217, 70, 239, 0.3); width: 100%; cursor: pointer; padding: 0.75rem; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fas fa-plus-circle"></i> Add Member Detail
          </button>
        </div>

        <!-- Course Dropdown -->
        <div>
          <label
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Department
            / Course</label>
          <div class="custom-dropdown-container" id="dept-dropdown">
            <input type="hidden" id="reg-dept" required>
            <div class="custom-dropdown-trigger" id="dept-trigger" style="box-sizing: border-box;">
              <span id="dept-selected-text">Select Course</span>
              <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="custom-dropdown-menu" id="dept-menu">
              <div class="custom-dropdown-group">
                <div class="custom-dropdown-group-label">Undergraduate</div>
                <div class="custom-dropdown-item" data-value="B.A Economics">B.A Economics</div>
                <div class="custom-dropdown-item" data-value="B.A Econometrics and Data Management">B.A Econometrics and
                  Data Management</div>
                <div class="custom-dropdown-item" data-value="B.A English Language and Literature">B.A English Language
                  and Literature</div>
                <div class="custom-dropdown-item" data-value="B.A History">B.A History</div>
                <div class="custom-dropdown-item" data-value="B.Sc Microbiology">B.Sc Microbiology</div>
                <div class="custom-dropdown-item" data-value="Bachelor of Travel and Tourism Management (BTTM)">Bachelor
                  of Travel and Tourism Management (BTTM)</div>
                <div class="custom-dropdown-item" data-value="B.A Journalism and Mass Communication">B.A Journalism and
                  Mass Communication</div>
                <div class="custom-dropdown-item" data-value="B.Sc Biochemistry">B.Sc Biochemistry</div>
              </div>
              <div class="custom-dropdown-group">
                <div class="custom-dropdown-group-label">Postgraduate</div>
                <div class="custom-dropdown-item" data-value="M.A Journalism & Mass Communication">M.A Journalism & Mass
                  Communication</div>
                <div class="custom-dropdown-item" data-value="M Com">M Com</div>
                <div class="custom-dropdown-item" data-value="M.A Economics">M.A Economics</div>
                <div class="custom-dropdown-item" data-value="Master of Travel and Tourism Management (MTTM)">Master of
                  Travel and Tourism Management (MTTM)</div>
                <div class="custom-dropdown-item" data-value="M.Sc Microbiology">M.Sc Microbiology</div>
                <div class="custom-dropdown-item" data-value="M.Sc Biochemistry">M.Sc Biochemistry</div>
              </div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 1rem;">
          <div id="roll-number-selection-container" style="flex: 1;">
            <label for="reg-roll"
              style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Roll
              No</label>
            <input type="text" id="reg-roll" placeholder="Roll No" required class="form-input"
              style="width: 100%; box-sizing: border-box;">
          </div>
          <div id="year-selection-container" style="flex: 1;">
            <label
              style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Year</label>

            <div class="custom-dropdown-container">
              <input type="hidden" id="reg-year" required>
              <div class="custom-dropdown-trigger" id="year-trigger" style="box-sizing: border-box; width: 100%;">
                <span id="year-selected-text">Select Year</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" id="year-menu">
                <div class="custom-dropdown-item" data-value="1">1st Year</div>
                <div class="custom-dropdown-item" data-value="2">2nd Year</div>
                <div class="custom-dropdown-item" data-value="3">3rd Year</div>
                <div class="custom-dropdown-item" data-value="4">4th Year</div>
              </div>
            </div>

          </div>
        </div>

        <div>
          <label for="reg-phone"
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Phone
            Number</label>
          <input type="tel" id="reg-phone" placeholder="+91 XXXXX XXXXX" required class="form-input"
            style="box-sizing: border-box;">
        </div>

        <!-- Gender Dropdown -->
        <div id="gender-selection-container">
          <label
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Gender</label>
          <div class="custom-dropdown-container">
            <input type="hidden" id="reg-gender" required>
            <div class="custom-dropdown-trigger" id="gender-trigger" style="box-sizing: border-box;">
              <span id="gender-selected-text">Select Gender</span>
              <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="custom-dropdown-menu" id="gender-menu">
              <div class="custom-dropdown-item" data-value="Male">Male</div>
              <div class="custom-dropdown-item" data-value="Female">Female</div>
              <div class="custom-dropdown-item" data-value="Other">Other</div>
            </div>
          </div>
        </div>

        <!-- Program/Item Dropdown -->
        <div id="prog-dropdown" style="display:none;">
          <label
            style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Program
            / Item</label>
          <div class="custom-dropdown-container">
            <input type="hidden" id="reg-program" required>
            <div class="custom-dropdown-trigger" id="prog-trigger" style="box-sizing: border-box;">
              <span id="prog-selected-text">Select Program / Item</span>
              <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="custom-dropdown-menu" id="prog-menu">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <button type="submit" class="cta-btn"
          style="border: none; cursor: pointer; margin-top: 1rem; width: 100%; font-size: 0.95rem; padding: 1rem; box-sizing: border-box;">Complete
          Registration</button>
      </form>
      <div id="reg-status" style="margin-top: 1rem; font-size: 0.875rem; min-height: 1.25rem;"></div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboard-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10001; justify-content: center; align-items: center; backdrop-filter: blur(10px);">
    <div class="auth-container"
      style="max-width: 600px; width: 90%; position: relative; animation: slideUp 0.3s ease-out; max-height: 80vh; overflow-y: auto;">
      <button id="close-leaderboard"
        style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>

      <h2 style="margin-top: 0; margin-bottom: 0.5rem; font-size: 1.75rem; font-family: var(--font-heading);">
        Leaderboard</h2>
      <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem;">Real-time department standings
      </p>

      <div id="leaderboard-content">
        <div style="padding: 2rem; text-align: center;">
          <div style="color: var(--text-secondary);">Loading scores...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Point Details Modal (Performance Analysis) -->
  <div id="point-details-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10005; justify-content: center; align-items: center; backdrop-filter: blur(15px);">
    <div class="auth-container"
      style="max-width: 800px; width: 95%; position: relative; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; padding: 2.5rem; background: #1e293b; border: 1px solid rgba(255,255,255,0.1);">
      <button id="close-point-details"
        style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem; opacity: 0.7; transition: opacity 0.2s;"
        onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">&times;</button>

      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div>
          <h2
            style="margin: 0; font-family: var(--font-heading); font-size: 1.75rem; color: white; margin-bottom: 0.25rem;">
            Performance Analysis</h2>
          <p id="details-dept-name"
            style="color: var(--accent-color); font-weight: 700; font-size: 1rem; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
            Department Name</p>
        </div>
      </div>

      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2.5rem; margin-bottom: 1.5rem;">
        <!-- Left Column: Chart -->
        <div
          style="background: rgba(15, 23, 42, 0.4); border-radius: 1.25rem; padding: 2rem; display: flex; align-items: center; justify-content: center; min-height: 320px; position: relative; border: 1px solid rgba(255,255,255,0.05);">
          <canvas id="scoreChart"></canvas>
          <div id="chart-loader" style="position: absolute; color: var(--text-secondary); font-size: 0.9rem;">Loading
            chart...</div>
          <div id="chart-no-data"
            style="display: none; position: absolute; color: var(--text-secondary); font-size: 0.9rem;">No data
            available</div>
        </div>

        <!-- Right Column: Recent Achievements -->
        <div style="display: flex; flex-direction: column;">
          <h3
            style="color: white; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-trophy" style="color: var(--accent-color);"></i> Recent Achievements
          </h3>
          <div id="point-details-content"
            style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 350px; overflow-y: auto; padding-right: 0.5rem;">
            <div style="padding: 2rem; text-align: center;">
              <div style="color: var(--text-secondary);">Loading records...</div>
            </div>
          </div>
        </div>
      </div>

      <div
        style="display: flex; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
        <button id="close-window-btn"
          style="background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 2rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
          onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.2)'"
          onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">Close
          Window</button>
      </div>
    </div>
  </div>

  <!-- PDF Preview Modal -->
  <div id="pdf-preview-modal" class="hidden">
    <div class="modal-content">
      <div class="pdf-toolbar">
        <div class="pdf-toolbar-title">PDF Preview</div>
        <div style="display: flex; gap: 1rem;">
          <button onclick="closePDFPreview()" class="btn-tab"
            style="background: rgba(255,255,255,0.1); border:none; color: #fff;">
            Cancel
          </button>
          <button id="download-pdf-confirm-btn" onclick="processPDFDownload()" class="btn-tab"
            style="background: var(--success); color: white; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>
      <div id="pdf-preview-container">
        <!-- Preview Content Injected Here -->
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10010; justify-content: center; align-items: center; backdrop-filter: blur(8px);">
    <div class="auth-container"
      style="max-width: 450px; width: 90%; text-align: center; position: relative; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto;">
      <div
        style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; border: 2px solid #10b981;">
        <svg style="width: 40px; height: 40px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>

      <h2 style="margin-top: 0; margin-bottom: 0.5rem; color: white; font-family: var(--font-heading);">Registration
        Confirmed!</h2>
      <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 2rem;">Please take a screenshot of these
        details for your reference.</p>

      <div id="success-details"
        style="text-align: left; background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 2rem; display: flex; flex-direction: column; gap: 0.8rem;">
        <!-- Filled by JS -->
      </div>

      <button id="close-success-btn" class="cta-btn" style="width: 100%; border: none; cursor: pointer;">Done</button>
    </div>
  </div>

  <!-- Custom Alert Modal -->
  <div id="custom-alert-modal">
    <div class="custom-alert-card">
      <div id="custom-alert-icon" class="custom-alert-icon">
        <i class="fas fa-info-circle"></i>
      </div>
      <h2 id="custom-alert-title" class="custom-alert-title">Notification</h2>
      <p id="custom-alert-message" class="custom-alert-message">Message goes here.</p>
      <button id="close-custom-alert" class="custom-alert-btn">Got it</button>
    </div>
  </div>

  <style>
    .success-detail-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .success-detail-label {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .success-detail-value {
      color: white;
      font-weight: 600;
      text-align: right;
    }
  </style>

  <style>
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Point Details Modal Specific Styles */
    .point-detail-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      transition: all 0.3s ease;
    }

    .point-detail-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .point-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .point-detail-pts {
      font-weight: 800;
      color: var(--accent-color);
      font-size: 1.1rem;
    }

    .point-detail-program {
      font-weight: 700;
      font-size: 0.95rem;
      color: white;
    }

    .point-detail-participant {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .point-detail-pos {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.05);
    }

    /* PDF Preview Modal Styles (Ported from admin.html) */
    #pdf-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    #pdf-preview-modal .modal-content {
      width: 95%;
      max-width: 1200px;
      height: 90vh;
      background: #525659;
      /* PDF Viewer Grey */
      border-radius: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .pdf-toolbar {
      padding: 1rem 1.5rem;
      background: #2b2f36;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #000;
    }

    .pdf-toolbar-title {
      font-weight: 600;
      font-size: 1rem;
      color: #e5e7eb;
    }

    #pdf-preview-container {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      padding: 2rem;
      position: relative;
    }

    #pdf-content-wrapper {
      background: white;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      transform-origin: top center;
    }

    .btn-tab {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      padding: 0.5rem 1.25rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .btn-tab:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onDisconnect, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    // Global Error Handler handled below in System Control

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCrjARB6MTC5s_sMPHzf3a1yW1ajHTKHU4",
      authDomain: "unionartsprc.firebaseapp.com",
      databaseURL: "https://unionartsprc-default-rtdb.firebaseio.com",
      projectId: "unionartsprc",
      storageBucket: "unionartsprc.firebasestorage.app",
      messagingSenderId: "812219989202",
      appId: "1:812219989202:web:cb94548572e7dcb5cc810b",
      measurementId: "G-WR8DBND5YD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const rtdb = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // Global system year variable
    let systemYear = "2025-26"; // Default fallback
    let publicLeaderboardListener = null;
    let leaderboardListener = null;

    // Fetch system year from Firestore
    // Listen to system year in real-time
    let systemYearListener = null;
    function startSystemYearListener() {
      if (systemYearListener) return;
      const yearRef = doc(db, "system_config", "current_year");
      systemYearListener = onSnapshot(yearRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          systemYear = data.year || "2025-26";
          console.log(`System year updated in real-time: ${systemYear}`);
        } else {
          console.log("No system year configured, using default: 2025-26");
          systemYear = "2025-26";
        }

        // Update all year labels
        const headerYear = document.getElementById('index-header-year');
        if (headerYear) headerYear.textContent = `ARTS FESTIVAL ${systemYear}`;

        const authYearBadge = document.getElementById('auth-year-badge');
        if (authYearBadge) authYearBadge.textContent = `Arts Fest ${systemYear}`;

        const indexYearBadge = document.getElementById('index-year-badge');
        if (indexYearBadge) indexYearBadge.textContent = systemYear;

        // If app is already initialized and year changes, refresh listeners
        if (typeof publicLeaderboardListener === 'function') {
          console.log("Restarting public leaderboard listener due to year change...");
          publicLeaderboardListener();
          publicLeaderboardListener = null;
          if (typeof startPublicLeaderboardListener === 'function') {
            startPublicLeaderboardListener();
          }
        }

        if (typeof leaderboardListener === 'function') {
          console.log("Resetting modal leaderboard listener due to year change...");
          leaderboardListener();
          leaderboardListener = null;
        }
      }, (error) => {
        console.warn("Year listener Error:", error);
        systemYearListener = null;
      });
    }

    // Initialize system year listener
    startSystemYearListener();

    // Deprecated for new code, but kept for compatibility
    async function fetchSystemYear() {
      try {
        const yearDoc = await getDoc(doc(db, "system_config", "current_year"));
        if (yearDoc.exists()) {
          systemYear = yearDoc.data().year || "2025-26";
        }
      } catch (e) { }
    }

    // --- System Control & Versioning ---
    const APP_VERSION = "1.0.3";
    const escapeHtml = (unsafe) => {
      if (unsafe === null || unsafe === undefined) return "";
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    function showToast(title, message, type = "info", action = null) {
      const container = document.getElementById('system-notifications');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;

      let actionHtml = '';
      if (action && action.label && action.callback) {
        actionHtml = `<button class="toast-action-btn"><i class="${action.icon || 'fas fa-sync'}"></i> ${action.label}</button>`;
      }

      toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-title">${title}</span>
          <span class="toast-message">${message}</span>
          ${actionHtml}
        </div>
        <button class="toast-close"><i class="fas fa-times"></i></button>
      `;

      if (action && action.callback) {
        const btn = toast.querySelector('.toast-action-btn');
        btn.onclick = (e) => {
          e.stopPropagation();
          action.callback();
        };
      }

      toast.querySelector('.toast-close').onclick = () => {
        if (action && action.onDismiss) action.onDismiss();
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      };

      container.appendChild(toast);

      // Auto-remove after 8 seconds if no action
      if (!action || !action.persistent) {
        setTimeout(() => {
          if (toast.parentElement) {
            if (action && action.onDismiss) action.onDismiss();
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
          }
        }, 8000);
      }
    }

    function showCustomAlert(title, message, type = 'info') {
      const modal = document.getElementById('custom-alert-modal');
      const titleElem = document.getElementById('custom-alert-title');
      const messageElem = document.getElementById('custom-alert-message');
      const iconElem = document.getElementById('custom-alert-icon');

      if (!modal || !titleElem || !messageElem || !iconElem) return;

      titleElem.textContent = title;
      messageElem.textContent = message;

      // Set icon based on type
      iconElem.className = `custom-alert-icon ${type}`;
      iconElem.innerHTML = type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-info-circle"></i>';

      modal.style.display = 'flex';
    }

    // Network Health Check
    async function validateConnection() {
      // 1. Basic Online Check
      if (!navigator.onLine) {
        throw new Error("Device is offline. Connection lost.");
      }

      // 2. Network Speed Check (Adaptive)
      // We check for effectiveType or downlink if available
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (conn) {
        console.log("Network Info:", { type: conn.effectiveType, downlink: conn.downlink, rtt: conn.rtt });

        // Block if speed is extremely low (less than 0.1 Mbps) or high latency
        if (conn.downlink < 0.15 || (conn.effectiveType === '2g' && conn.rtt > 2000)) {
          throw new Error("Network speed is too slow/weak to ensure data integrity. Please move to a better coverage area.");
        }
      }

      // 3. Ping Test (Optional, but good for "weak" detection)
      try {
        const start = Date.now();
        // Just a small fetch to check latency if navigator.connection is missing
        if (!conn) {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', signal: controller.signal });
          clearTimeout(timeoutId);
          const rtt = Date.now() - start;
          if (rtt > 3000) throw new Error("High latency detected.");
        }
      } catch (e) {
        if (e.name === 'AbortError') throw new Error("Connection is too weak (Timeout).");
        // Ignore other fetch errors as it might be CORS or blocked by browser
      }

      return true;
    }

    // Version Control
    async function checkForUpdates() {
      // 1. Grace Period Check (Prevent loop immediately after refresh)
      const lastRefresh = sessionStorage.getItem('app_refresh_timestamp');
      if (lastRefresh && (Date.now() - parseInt(lastRefresh)) < 60000) {
        return; // Ignore updates for 60 seconds after a manual refresh
      }

      try {
        const configRef = doc(db, "app_config", "version");
        const docSnap = await getDoc(configRef);

        if (docSnap.exists()) {
          const remoteVersion = String(docSnap.data().current || "").trim();

          if (remoteVersion && remoteVersion !== APP_VERSION) {
            // Check if user already dismissed THIS specific version
            const dismissedVer = localStorage.getItem('dismissed_app_version');
            if (dismissedVer === remoteVersion) return;

            showToast("Update Available", `A new version (${remoteVersion}) is available. (You are on ${APP_VERSION})`, "info", {
              label: "Refresh Now",
              icon: "fas fa-redo",
              callback: () => {
                sessionStorage.setItem('app_refresh_timestamp', Date.now().toString());
                localStorage.removeItem('dismissed_app_version');
                // Cache-busting: add a timestamp to force a hard reload from server
                const url = new URL(window.location.href);
                url.searchParams.set('v', Date.now());
                window.location.href = url.toString();
              },
              onDismiss: () => {
                localStorage.setItem('dismissed_app_version', remoteVersion);
              }
            });
          }
        }
      } catch (error) {
        console.warn("Update check failed:", error);
      }
    }

    // Periodic Update Check
    setInterval(checkForUpdates, 1000 * 60 * 15); // Every 15 minutes
    setTimeout(checkForUpdates, 5000); // Initial check after 5s

    // Real-time Network Monitoring
    const networkStatusBar = document.getElementById('network-status-bar');
    const updateNetworkStatus = () => {
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!navigator.onLine) {
        if (networkStatusBar) {
          networkStatusBar.style.display = 'block';
          networkStatusBar.style.background = '#ef4444';
          networkStatusBar.innerHTML = '<i class="fas fa-wifi-slash"></i> You are currently offline. Functionality limited.';
        }
      } else if (conn && (conn.effectiveType === '2g' || conn.downlink < 0.3)) {
        if (networkStatusBar) {
          networkStatusBar.style.display = 'block';
          networkStatusBar.style.background = '#f59e0b';
          networkStatusBar.innerHTML = '<i class="fas fa-signal"></i> Weak network detected. Registration might be slow or fail.';
        }
      } else {
        if (networkStatusBar) networkStatusBar.style.display = 'none';
      }
    };

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    if (navigator.connection) navigator.connection.addEventListener('change', updateNetworkStatus);
    updateNetworkStatus();

    // Enhanced Error Handling
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      console.error('System Error:', msg, 'Line:', lineNo);
      showToast("System Error", "An unexpected error occurred. If the app feels unstable, try refreshing.", "error", {
        label: "Refresh App",
        icon: "fas fa-sync",
        callback: () => window.location.reload()
      });
      return false;
    };

    window.onunhandledrejection = function (event) {
      console.error('Promise Rejection:', event.reason);
      if (event.reason && event.reason.message && event.reason.message.includes("Network")) {
        // Silently handle common network rejections as we have status bar
        return;
      }
      showToast("Action Failed", "Something went wrong. Please try again or refresh.", "warning");
    };

    // --- Point Details & Performance Analysis (Publicly Accessible) ---
    const pointDetailsModal = document.getElementById('point-details-modal');
    const closePointDetailsBtn = document.getElementById('close-point-details');
    const closeWindowBtn = document.getElementById('close-window-btn');
    const pointDetailsContent = document.getElementById('point-details-content');
    const detailsDeptNameElem = document.getElementById('details-dept-name');
    let currentScoreChart = null;

    window.showPointDetails = async (dept, totalScore) => {
      if (pointDetailsModal) pointDetailsModal.style.display = 'flex';
      if (detailsDeptNameElem) detailsDeptNameElem.textContent = dept;

      const chartLoader = document.getElementById('chart-loader');
      const chartNoData = document.getElementById('chart-no-data');
      const canvas = document.getElementById('scoreChart');

      if (chartLoader) chartLoader.style.display = 'block';
      if (chartNoData) chartNoData.style.display = 'none';
      if (canvas) canvas.style.display = 'none';

      if (pointDetailsContent) {
        pointDetailsContent.innerHTML = '<div style="padding: 2rem; text-align: center;"><div style="color: var(--text-secondary);">Loading records...</div></div>';
      }

      if (currentScoreChart) {
        currentScoreChart.destroy();
        currentScoreChart = null;
      }

      try {
        // Fetch logs for the department AND academic year
        const q = query(collection(db, "score_logs"),
          where("department", "==", dept),
          where("academicYear", "==", systemYear)
        );
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          if (pointDetailsContent) pointDetailsContent.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No point records found.</div>';
          if (chartLoader) chartLoader.style.display = 'none';
          if (chartNoData) chartNoData.style.display = 'block';
          return;
        }

        // Map and sort on client side
        const logs = [];
        const dataMap = {};
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          logs.push(data);

          const item = data.itemName || "Other";
          const pts = data.points || 0;
          dataMap[item] = (dataMap[item] || 0) + pts;
        });

        // Sort by timestamp if it exists (newest first)
        logs.sort((a, b) => {
          const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          return timeB - timeA;
        });

        // Render Achievements List
        let html = '';
        logs.forEach((log) => {
          const dateStr = log.timestamp ? new Date(log.timestamp).toLocaleDateString() : '';
          html += `
            <div class="point-detail-item" style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 0.75rem; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 0.4rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 800; color: var(--accent-color); font-size: 1.1rem;">+${log.points} Points</span>
                <span style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-secondary);">${log.position || log.type || 'Awarded'}</span>
              </div>
              <div style="font-weight: 700; font-size: 0.95rem; color: white;">${log.itemName || 'Manual Adjustment'}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">${log.participantName || 'N/A'} \u2022 ${dateStr}</div>
            </div>
          `;
        });
        if (pointDetailsContent) pointDetailsContent.innerHTML = html;

        // Render Chart
        if (chartLoader) chartLoader.style.display = 'none';
        if (canvas) {
          canvas.style.display = 'block';
          const ctx = canvas.getContext('2d');
          currentScoreChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(dataMap),
              datasets: [{
                data: Object.values(dataMap),
                backgroundColor: [
                  '#f472b6', '#a78bfa', '#22d3ee', '#34d399', '#fbbf24', '#f87171', '#60a5fa'
                ],
                borderWidth: 0,
                hoverOffset: 12
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: '#cbd5e1',
                    font: { family: 'Inter', size: 11 },
                    padding: 20
                  }
                },
                tooltip: {
                  callbacks: {
                    label: (context) => ` ${context.label}: ${context.raw} Points`
                  }
                }
              },
              cutout: '65%'
            }
          });
        }

      } catch (error) {
        console.error("Error fetching point details:", error);
        if (pointDetailsContent) pointDetailsContent.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ef4444;">Failed to load records.</div>';
        if (chartLoader) chartLoader.style.display = 'none';
      }
    };

    const closePointDetails = () => {
      if (pointDetailsModal) pointDetailsModal.style.display = 'none';
      if (currentScoreChart) {
        currentScoreChart.destroy();
        currentScoreChart = null;
      }
    };

    if (closePointDetailsBtn) closePointDetailsBtn.addEventListener('click', closePointDetails);
    if (closeWindowBtn) closeWindowBtn.addEventListener('click', closePointDetails);
    if (pointDetailsModal) pointDetailsModal.addEventListener('click', (e) => {
      if (e.target === pointDetailsModal) closePointDetails();
    });

    const authOverlay = document.getElementById('auth-overlay');
    const mainContent = document.getElementById('main-content');
    const authStatus = document.getElementById('auth-status');
    const signinBtn = document.getElementById('google-signin-btn');
    const logoutBtn = document.getElementById('logout-btn');


    const ADMIN_EMAILS = ["collageunionprc@gmail.com", "collegeunionprc@gmail.com", "artsfest@prc.ac.in", "angeljose54695@gmail.com", "capthedonsankar@gmail.com", "shobinmcj@gmail.com"];
    let isAppInitialized = false;
    let regSettings = { onStageLocked: false, offStageLocked: false };
    let userDepartment = null; // Store user's assigned department
    let userRole = "Main"; // Store user's role (Main/Sub)
    let userAllowedCourses = []; // Store user's allowed courses
    let isFirestoreAdmin = false; // Store if user is actually a firestore admin
    let userPermissions = { canRegisterOffStage: false, canRegisterOnStage: false };

    // Map of department names to their full course names
    const departmentCourseMap = {
      "Dep. of Economics": ["B.A Economics", "B.A Econometrics and Data Management", "M.A Economics"],
      "Dep. of English": ["B.A English Language and Literature"],
      "Dep. of History": ["B.A History"],
      "Dep. of Microbiology": ["B.Sc Microbiology", "M.Sc Microbiology"],
      "Dep. of Travel and Tourism": ["Bachelor of Travel and Tourism Management (BTTM)", "Master of Travel and Tourism Management (MTTM)"],
      "Tourism": ["Bachelor of Travel and Tourism Management (BTTM)", "Master of Travel and Tourism Management (MTTM)"],
      "Dep. of Journalism and Mass Communication": ["B.A Journalism and Mass Communication", "M.A Journalism & Mass Communication"],
      "Dep. of Biochemistry": ["B.Sc Biochemistry", "M.Sc Biochemistry"],
      "Dep. of Commerce": ["BBA", "M.COM"]
    };

    const checkWhitelistStatus = async (email) => {
      const emailLower = email.toLowerCase();
      if (ADMIN_EMAILS.includes(emailLower) || ADMIN_EMAILS.includes(email)) return { authorized: true, department: "Main Admin" };
      try {
        // Ensure systemYear is loaded (if somehow called before fetchSystemYear finished)
        if (!systemYear) await fetchSystemYear();

        // Try direct document lookup first (new format: email_year)
        const yearScopedId = `${emailLower}_${systemYear}`;
        const docRef = doc(db, "whitelisted_emails", yearScopedId);
        const docSnap = await getDoc(docRef);

        let data = null;
        if (docSnap.exists()) {
          data = docSnap.data();
        } else {
          // Fallback: search by email field (legacy format but with year filter)
          const q = query(collection(db, "whitelisted_emails"),
            where("email", "==", emailLower),
            where("academicYear", "==", systemYear)
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            data = querySnapshot.docs[0].data();
          }
        }

        if (data) {
          return {
            authorized: true,
            department: data.department || "User",
            role: data.role || "Main",
            allowedCourses: data.allowedCourses || [],
            canRegisterOffStage: data.canRegisterOffStage || false,
            canRegisterOnStage: data.canRegisterOnStage || false
          };
        }
        return { authorized: false };
      } catch (error) {
        console.error("Whitelist check failed:", error);
        return { authorized: false };
      }
    };

    const handleAuthChange = async (user) => {
      try {
        if (user) {
          console.log("Auth state changed: Logged in as", user.email);
          if (authStatus) authStatus.textContent = "Verifying access...";

          // Presence Tracking
          const userStatusRef = ref(rtdb, 'status/' + user.uid);
          const isOfflineForDatabase = {
            state: 'offline',
            last_changed: serverTimestamp(),
            email: user.email,
            displayName: user.displayName,
            role: userDepartment || 'User'
          };
          const isOnlineForDatabase = {
            state: 'online',
            last_changed: serverTimestamp(),
            email: user.email,
            displayName: user.displayName,
            role: userDepartment || 'User'
          };

          try {
            onValue(ref(rtdb, '.info/connected'), (snapshot) => {
              if (snapshot.val() === false) return;
              onDisconnect(userStatusRef).set(isOfflineForDatabase)
                .then(() => {
                  set(userStatusRef, isOnlineForDatabase)
                    .then(() => {
                      // Record history
                      push(ref(rtdb, 'status_history/' + user.uid), {
                        state: 'online',
                        timestamp: serverTimestamp(),
                        email: user.email
                      }).catch(err => console.warn('Status history write failed:', err));
                    })
                    .catch(err => console.warn('User status write failed:', err));
                })
                .catch(err => console.warn('OnDisconnect setup failed:', err));
            }, (error) => {
              // Error handler for onValue listener
              console.warn('Presence tracking unavailable:', error);
            });
          } catch (error) {
            console.warn('Failed to initialize presence tracking:', error);
          }



          // Ensure year is loaded before checking whitelist
          await fetchSystemYear();
          const authResult = await checkWhitelistStatus(user.email);

          // Check for true Firestore admin status
          try {
            const adminDocRef = doc(db, "admin_users", user.uid);
            const adminDocByEmailRef = doc(db, "admin_users", user.email.toLowerCase());
            const [uidSnap, emailSnap] = await Promise.all([getDoc(adminDocRef), getDoc(adminDocByEmailRef)]);
            isFirestoreAdmin = uidSnap.exists() || emailSnap.exists() || ADMIN_EMAILS.includes(user.email.toLowerCase());
          } catch (e) {
            console.warn("Could not verify Firestore admin status:", e);
          }

          if (authResult.authorized) {
            if (authOverlay) authOverlay.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');

            // Store user's department and permissions
            userDepartment = authResult.department;
            userRole = authResult.role || (userDepartment === "Main Admin" ? "Main" : "Main");
            userAllowedCourses = authResult.allowedCourses || [];
            userPermissions = {
              canRegisterOffStage: authResult.canRegisterOffStage || isFirestoreAdmin,
              canRegisterOnStage: authResult.canRegisterOnStage || isFirestoreAdmin
            };
            console.log("User department:", userDepartment, "Role:", userRole, "Firestore Admin:", isFirestoreAdmin);

            if (!isAppInitialized) {
              console.log("Starting App Initialization...");
              startSettingsListener(); // Ensure listener is active after login
              initApp();
              isAppInitialized = true;
              // Show registration guide popup only if registration is not fully closed
              const regGuideModal = document.getElementById('reg-guide-modal');
              const bothLocked = regSettings.onStageLocked && regSettings.offStageLocked;
              if (regGuideModal && !bothLocked) regGuideModal.classList.add('active');
            }
          } else {
            console.warn("Unauthorized user:", user.email);
            if (authStatus) authStatus.textContent = `Access Denied: ${user.email} is not whitelisted.`;
            setTimeout(() => {
              push(ref(rtdb, 'status_history/' + user.uid), {
                state: 'offline',
                timestamp: serverTimestamp(),
                email: user.email,
                note: 'Unauthorized access'
              });
              signOut(auth);
            }, 3000);
          }
        } else {
          if (authOverlay) authOverlay.classList.remove('hidden');
          if (mainContent) mainContent.classList.add('hidden');
          if (authStatus) authStatus.textContent = "";
        }
      } catch (err) {
        console.error("Auth handler critical error:", err);
        if (authStatus) authStatus.textContent = "An error occurred during sign-in. Please refresh.";
      }
    };

    onAuthStateChanged(auth, handleAuthChange);

    // Listen to registration settings in real-time
    let settingsListener = null;
    function startSettingsListener() {
      if (settingsListener) return;
      const settingsRef = doc(db, "settings", "registration");
      settingsListener = onSnapshot(settingsRef, (docSnap) => {
        if (docSnap.exists()) {
          regSettings = docSnap.data();
          console.log("Registration settings updated:", regSettings);
          updateRegistrationUI();
        }
      }, (error) => {
        console.warn("Settings listener encounterd an error (expected if not logged in):", error.message);
        settingsListener = null; // Allow restart
      });
    }

    // Attempt initially
    startSettingsListener();

    function updateRegistrationUI() {
      const ctaBtn = document.querySelector('.cta-btn[href="#events"]');
      const eventCards = document.querySelectorAll('.event-card');

      const bothLocked = regSettings.onStageLocked && regSettings.offStageLocked;

      if (ctaBtn) {
        if (bothLocked) {
          ctaBtn.innerHTML = '<i class="fas fa-lock" style="margin-right: 8px;"></i> Registration Closed';
          ctaBtn.style.background = 'linear-gradient(135deg, #475569, #1e293b)';
          ctaBtn.style.boxShadow = 'none';
        } else {
          ctaBtn.innerHTML = 'Register For Events';
          ctaBtn.style.background = ''; // Revert to CSS default
          ctaBtn.style.boxShadow = '';
        }
      }

      // Update the homepage register button
      const registerBtn = document.getElementById('register-btn');
      if (registerBtn) {
        if (bothLocked) {
          registerBtn.innerHTML = '\u003ci class="fas fa-lock"\u003e\u003c/i\u003e Registration Closed';
          registerBtn.classList.add('closed-btn');
          registerBtn.style.cursor = 'not-allowed';
          registerBtn.onclick = null;
        } else {
          registerBtn.innerHTML = '\u003ci class="fas fa-edit"\u003e\u003c/i\u003e Register Now';
          registerBtn.classList.remove('closed-btn');
          registerBtn.style.cursor = 'pointer';
          registerBtn.onclick = () => {
            // Scroll to events section
            const eventsSection = document.getElementById('events');
            if (eventsSection) {
              eventsSection.scrollIntoView({ behavior: 'smooth' });
            }
          };
        }
      }

      eventCards.forEach(card => {
        const titleElem = card.querySelector('.event-title');
        if (!titleElem) return;
        const title = titleElem.textContent;

        let isLocked = false;
        if (title === "On Stage" && regSettings.onStageLocked) isLocked = true;
        if (title === "Off Stage" && regSettings.offStageLocked) isLocked = true;

        // Check for existing badge
        let badge = card.querySelector('.closed-badge');

        if (isLocked) {
          card.style.opacity = '0.7';
          if (!badge) {
            badge = document.createElement('div');
            badge.className = 'closed-badge';
            badge.innerHTML = '<i class="fas fa-lock"></i> CLOSED';
            badge.style.cssText = `
              position: absolute;
              top: 1rem;
              right: 1rem;
              background: rgba(239, 68, 68, 0.9);
              color: white;
              padding: 0.25rem 0.75rem;
              border-radius: 2rem;
              font-size: 0.7rem;
              font-weight: 800;
              letter-spacing: 0.05em;
              display: flex;
              align-items: center;
              gap: 0.4rem;
              z-index: 10;
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            card.appendChild(badge);
          }
        } else {
          card.style.opacity = '1';
          if (badge) badge.remove();
        }
      });
    }

    if (signinBtn) {
      signinBtn.onclick = async () => {
        if (authStatus) authStatus.textContent = "Signing in...";
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          if (authStatus) authStatus.textContent = `Login failed: ${error.message}`;
        }
      };
    }

    if (logoutBtn) {
      logoutBtn.onclick = () => {
        if (confirm("Are you sure you want to logout?")) {
          const user = auth.currentUser;
          if (user) {
            push(ref(rtdb, 'status_history/' + user.uid), {
              state: 'offline',
              timestamp: serverTimestamp(),
              email: user.email
            });
          }
          signOut(auth);
        }
      };
    }

    // Public Flip & Leaderboard Logic
    const authFlipCard = document.getElementById('auth-flip-card');
    const viewStandingsBtn = document.getElementById('view-standings-btn');
    const backToLoginBtn = document.getElementById('back-to-login-btn');
    const publicLeaderboardContent = document.getElementById('public-leaderboard-content');
    // publicLeaderboardListener moved to top
    let currentLeaderboardSummary = "";

    const flipToBack = () => {
      if (authFlipCard) authFlipCard.classList.add('flipped');
      startPublicLeaderboardListener();
    };

    const flipToFront = () => {
      if (authFlipCard) authFlipCard.classList.remove('flipped');
    };

    if (viewStandingsBtn) viewStandingsBtn.onclick = flipToBack;
    if (backToLoginBtn) backToLoginBtn.onclick = flipToFront;

    // Check for deep link to leaderboard (Run immediately for public access)
    // Check for deep link to leaderboard (Run immediately for public access)
    // Supports both hash (new) and query param (legacy support)
    const checkDeepLink = () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (window.location.hash === '#leaderboard' || urlParams.get('view') === 'leaderboard') {
        // Small delay to ensure visual transition or immediate state
        setTimeout(flipToBack, 300);
      }
    };
    checkDeepLink();

    // Sharing Logic
    const shareLeaderboardBtn = document.getElementById('share-leaderboard-btn');
    if (shareLeaderboardBtn) {
      shareLeaderboardBtn.onclick = async () => {
        const shareText = currentLeaderboardSummary
          ? `\uD83C\uDFC6 PRC Arts Day Update: ${currentLeaderboardSummary}! Check full standings here:`
          : '\uD83C\uDFC6 Check out the latest live department standings for the College Arts Day at Pazhassiraja College Pulpally!';

        const shareUrl = `${window.location.origin}/#leaderboard`;

        const shareData = {
          title: 'PRC College Arts Day Leaderboard',
          text: shareText,
          url: shareUrl
        };

        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareUrl);
            const originalIcon = shareLeaderboardBtn.innerHTML;
            shareLeaderboardBtn.innerHTML = '<i class="fas fa-check"></i>';
            shareLeaderboardBtn.style.color = '#34d399';
            shareLeaderboardBtn.style.borderColor = '#34d399';
            setTimeout(() => {
              shareLeaderboardBtn.innerHTML = originalIcon;
              shareLeaderboardBtn.style.color = 'var(--accent-color)';
              shareLeaderboardBtn.style.borderColor = 'rgba(217, 70, 239, 0.2)';
            }, 2000);
          }
        } catch (err) {
          console.log('Share failed:', err);
        }
      };
    }

    // Swipe Support for Auth Flip Card
    let touchStartX = 0;
    let touchEndX = 0;

    authFlipCard?.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    authFlipCard?.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });

    const handleSwipe = () => {
      const diff = touchEndX - touchStartX;
      if (Math.abs(diff) > 50) { // Threshold
        if (diff < 0) flipToBack(); // Swipe Left
        else flipToFront(); // Swipe Right
      }
    };

    /*
    // 3D Tilt Effect
    document.addEventListener('mousemove', (e) => {
      const cards = document.querySelectorAll('.auth-card');
      if (!cards.length) return;

      const width = window.innerWidth;
      const height = window.innerHeight;
      const mouseX = e.clientX;
      const mouseY = e.clientY;

      // Calculate rotation based on mouse position
      // Max tilt: 10 degrees
      const rotateY = ((mouseX - width / 2) / width) * 10;
      const rotateX = ((mouseY - height / 2) / height) * -10;

      cards.forEach(card => {
        // Apply transform to the card content, not the flip container
        // This creates a subtle parallax feel
        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        card.style.transition = 'transform 0.1s ease-out'; // Smooth follow
      });
    });

    // Reset tilt on mouse leave
    document.addEventListener('mouseleave', () => {
      const cards = document.querySelectorAll('.auth-card');
      cards.forEach(card => {
        card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
        card.style.transition = 'transform 0.5s ease-out';
      });
    });
    */

    function startPublicLeaderboardListener() {
      if (publicLeaderboardListener) return;

      console.log(`Starting Public Leaderboard Listener for ${systemYear}...`);
      const q = query(collection(db, "leaderboard"), where("academicYear", "==", systemYear));

      publicLeaderboardListener = onSnapshot(q, (snapshot) => {
        if (!publicLeaderboardContent) return;

        if (snapshot.empty) {
          publicLeaderboardContent.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-secondary);">No scores yet.</div>';
          return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0.25rem;">';
        currentLeaderboardSummary = "";
        const leaderboardMap = new Map();
        snapshot.forEach(doc => {
          const data = doc.data();
          const deptName = data.department || doc.id;
          const score = data.score || 0;
          const docId = doc.id;

          // Logic: If same department seen twice, prefer the one with the "official" ID format (Dept_Year)
          const isOfficialId = docId === `${deptName}_${systemYear}`;

          if (!leaderboardMap.has(deptName) || isOfficialId) {
            leaderboardMap.set(deptName, {
              id: docId,
              department: deptName,
              score: score
            });
          }
        });

        const leaderboardData = Array.from(leaderboardMap.values());

        // Sort client-side to bypass composite index requirement
        leaderboardData.sort((a, b) => b.score - a.score);

        // Filter out BA programs from public leaderboard
        const filteredLeaderboardData = leaderboardData.filter(data =>
          data.id !== "B.A Economics" && data.id !== "B.A Econometrics and Data Management"
        );

        filteredLeaderboardData.forEach((data, index) => {
          const score = data.score;
          const rank = index + 1;

          // Check for tie
          const isTie = (index > 0 && filteredLeaderboardData[index - 1].score === score) ||
            (index < filteredLeaderboardData.length - 1 && filteredLeaderboardData[index + 1].score === score);

          if (rank === 1) {
            currentLeaderboardSummary = `${data.id} is leading with ${score} points`;
          }

          const rankClass = rank <= 3 ? `rank-${rank}` : '';
          let rankIcon;

          if (isTie) {
            rankIcon = '<span style="font-size: 0.7rem; font-weight: 800;">TIE</span>';
          } else {
            rankIcon = rank === 1 ? '<i class="fas fa-trophy"></i>' : (rank === 2 || rank === 3 ? '<i class="fas fa-medal"></i>' : `#${rank}`);
          }

          const delay = index * 0.05; // Staggered delay

          html += `
            <div class="leaderboard-item ${rankClass}" 
                 onclick="showPointDetails('${(data.department || data.id).replace(/'/g, "\\'")}', ${score})"
                 style="animation-delay: ${delay}s">
              <div class="rank-number">${rankIcon}</div>
              <div class="dept-name">${escapeHtml(data.department || data.id)}</div>
              <div class="score-value">${score}</div>
              <i class="fas fa-chevron-right" style="font-size: 0.6rem; color: rgba(255,255,255,0.15); margin-left: 0.25rem;"></i>
            </div>
          `;
        });

        html += '</div>';
        publicLeaderboardContent.innerHTML = html;
      }, (error) => {
        console.error("Public Leaderboard Listener Error:", error);
        if (publicLeaderboardContent) {
          publicLeaderboardContent.innerHTML = '<div style="padding:2rem; text-align:center; color:#ef4444;">Error loading scores.</div>';
        }
      });
    }

    async function initApp() {
      console.log("Initializing App...");

      // Constant for Off Stage Events
      const OFF_STAGE_EVENTS = [
        "Essay Writing (English)", "Essay Writing (Arabic)", "Essay Writing (Hindi)", "Essay Writing (Malayalam)", "Essay Writing (Tamil)", "Essay Writing (Urdu)",
        "Story Writing (English)", "Story Writing (Arabic)", "Story Writing (Hindi)", "Story Writing (Malayalam)", "Story Writing (Tamil)", "Story Writing (Urdu)",
        "Versification (English)", "Versification (Arabic)", "Versification (Hindi)", "Versification (Malayalam)", "Versification (Tamil)", "Versification (Urdu)",
        "Extempore (English)", "Extempore (Hindi)", "Extempore (Malayalam)", "Extempore (Tamil)",
        "Aksharashlokam",
        "Kavyakeli",
        "Water Colour",
        "Oil Colour",
        "Cartoon Drawing",
        "Pencil Drawing",
        "Clay Modeling",
        "Collage",
        "Embroidery",
        "Poster Making",
        "Rangoli",
        "Spot Photography"
      ];

      // Constant for On Stage Individual Events
      const ON_STAGE_INDIVIDUAL_EVENTS = [
        "Light Music Boys", "Light Music Girls",
        "Classical Music Boys", "Classical Music Girls",
        "Mappila Pattu Boys", "Mappila Pattu Girls",
        "Western Song",
        "Poem Recitation (Malayalam)", "Poem Recitation (English)", "Poem Recitation (Hindi)", "Poem Recitation (Arabic)", "Poem Recitation (Tamil)", "Poem Recitation (Urdu)",
        "Percussion Instruments Eastern",
        "String Instruments Eastern",
        "String Instruments Western",
        "Bharatanatyam",
        "Mohiniyattam",
        "Classical Dance (Odissi)", "Classical Dance (Kathak)", "Classical Dance (Manipuri)", "Classical Dance (Kuchipudi)",
        "Folk Dance Boys", "Folk Dance Girls",
        "Kerala Natanam",
        "Monoact",
        "Mimicry",
        "Kadha Presangam"
      ];

      // Constant for On Stage Group Events
      const ON_STAGE_GROUP_EVENTS = [
        "Group Song (Indian)",
        "Group Song (Western)",
        "Mappila Paattu Group",
        "Folk Music Group",
        "Patriotic Song Group",
        "Ganamela",
        "Folk Dance Group",
        "Thiruvathira",
        "Kolkali",
        "Daf Mutt",
        "Oppana",
        "Vattapatt",
        "Margamkali",
        "Drama",
        "Mime",
        "Skit"
      ];

      // Combined array for backward compatibility (filters, etc.)
      const ON_STAGE_EVENTS = [...ON_STAGE_INDIVIDUAL_EVENTS, ...ON_STAGE_GROUP_EVENTS];


      try {

        // Refs
        const regModal = document.getElementById('reg-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalCategory = document.getElementById('modal-category');
        const regForm = document.getElementById('reg-form');
        const regStatus = document.getElementById('reg-status');
        const eventCards = document.querySelectorAll('.event-card');

        // Program Dropdown Refs
        const progDropdown = document.getElementById('prog-dropdown');
        const progMenu = document.getElementById('prog-menu');
        const progTrigger = document.getElementById('prog-trigger');
        const progSelectedText = document.getElementById('prog-selected-text');
        const progInput = document.getElementById('reg-program');

        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard');
        const leaderboardContent = document.getElementById('leaderboard-content');

        const successModal = document.getElementById('success-modal');
        const successDetails = document.getElementById('success-details');
        const closeSuccessBtn = document.getElementById('close-success-btn');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const closeCustomAlertBtn = document.getElementById('close-custom-alert');

        if (closeCustomAlertBtn && customAlertModal) {
          closeCustomAlertBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
          });
          customAlertModal.addEventListener('click', (e) => {
            if (e.target === customAlertModal) customAlertModal.style.display = 'none';
          });
        }

        const regNameInput = document.getElementById('reg-name');
        if (regNameInput) {
          regNameInput.addEventListener('input', () => {
            regNameInput.value = regNameInput.value.toUpperCase();
          });
        }

        const regGroupNameInput = document.getElementById('reg-group-name');
        if (regGroupNameInput) {
          regGroupNameInput.addEventListener('input', () => {
            regGroupNameInput.value = regGroupNameInput.value.toUpperCase();
          });
        }

        // Populate Department Dropdown based on user's assigned department
        const deptMenu = document.getElementById('dept-menu');
        if (deptMenu && userDepartment) {
          console.log("Filtering departments for:", userDepartment);

          // If Main Admin, show all departments
          if (userDepartment === "Main Admin") {
            console.log("Main Admin - showing all departments");
            // Keep existing HTML (all departments already in HTML)
          } else {
            // Filter to show only user's department courses OR specific allowed courses
            let userCourses = userAllowedCourses.length > 0 ? userAllowedCourses : (departmentCourseMap[userDepartment] || []);

            if (userCourses.length > 0) {
              console.log("User courses for registration:", userCourses);

              // Build HTML for only the user's courses
              let html = '';
              userCourses.forEach(course => {
                html += `<div class="custom-dropdown-item" data-value="${course}">${course}</div>`;
              });

              deptMenu.innerHTML = html;

              // Auto-select if only one option
              if (userCourses.length === 1) {
                const singleCourse = userCourses[0];
                const deptInput = document.getElementById('reg-dept');
                const deptText = document.getElementById('dept-selected-text');
                const deptTrigger = document.getElementById('dept-trigger');

                if (deptInput && deptText && deptTrigger) {
                  deptInput.value = singleCourse;
                  deptText.textContent = singleCourse;
                  deptText.style.color = "white";
                  deptTrigger.classList.add('has-value');
                }
              }
            } else {
              // Fallback: if department not mapped, show a message
              deptMenu.innerHTML = `<div class="custom-dropdown-item" data-value="${userDepartment}">${userDepartment}</div>`;
            }
          }
        }

        let currentCategory = "";

        // About Toggle Logic
        const aboutSection = document.getElementById('about');
        if (aboutSection) {
          aboutSection.addEventListener('click', () => {
            aboutSection.classList.toggle('expanded');
          });
        }

        // Registration Guide Popup Close Logic
        const closeGuideBtn = document.getElementById('close-guide-popup');
        const regGuideModal = document.getElementById('reg-guide-modal');
        if (closeGuideBtn && regGuideModal) {
          closeGuideBtn.addEventListener('click', () => {
            regGuideModal.classList.remove('active');
          });
        }

        // Mobile Navigation Logic
        const hamburger = document.getElementById('hamburger-menu');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const mobileLinks = document.querySelectorAll('.mobile-link');
        const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

        const toggleMobileNav = () => {
          if (!hamburger || !mobileDrawer || !mobileOverlay) return;
          hamburger.classList.toggle('active');
          mobileDrawer.classList.toggle('active');
          mobileOverlay.classList.toggle('active');
          document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
        };

        if (hamburger && mobileDrawer && mobileOverlay) {
          hamburger.addEventListener('click', toggleMobileNav);
          mobileOverlay.addEventListener('click', toggleMobileNav);
        }

        mobileLinks.forEach(link => {
          link.addEventListener('click', () => {
            toggleMobileNav();
          });
        });

        if (mobileLogoutBtn) {
          mobileLogoutBtn.onclick = () => {
            toggleMobileNav();
            if (confirm("Are you sure you want to logout?")) {
              signOut(auth);
            }
          };
        }

        // Handle Navigation Link for About
        document.querySelectorAll('nav a[href="#about"]').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            aboutSection.scrollIntoView({ behavior: 'smooth' });
            if (!aboutSection.classList.contains('expanded')) {
              aboutSection.classList.add('expanded');
            }
          });
        });

        eventCards.forEach(card => {
          card.addEventListener('click', () => {
            console.log("Card Clicked");
            const titleElem = card.querySelector('.event-title');
            if (!titleElem) return;

            const title = titleElem.textContent;
            currentCategory = title;

            // Check if registration is locked
            let isLocked = false;
            let bypassRequested = false;

            if (title === "On Stage" && regSettings.onStageLocked) {
              if (userPermissions.canRegisterOnStage) {
                console.log("On Stage is locked, but user has bypass permission.");
                bypassRequested = true;
              } else {
                isLocked = true;
              }
            }
            if (title === "Off Stage" && regSettings.offStageLocked) {
              if (userPermissions.canRegisterOffStage) {
                console.log("Off Stage is locked, but user has bypass permission.");
                bypassRequested = true;
              } else {
                isLocked = true;
              }
            }

            if (isLocked) {
              if (isFirestoreAdmin) {
                // For admin, offer bypass with warning
                if (!confirm(`Registration for ${title} is CLOSED. As an Admin, do you want to BYPASS this and register anyway?`)) {
                  return;
                }
              } else {
                showCustomAlert("Registration Closed", `Registration for ${title} events is currently closed. Please check back later.`, "warning");
                return;
              }
            }

            if (modalCategory) modalCategory.textContent = "Registering for: " + title;
            if (regModal) regModal.style.display = 'flex';
            if (regStatus) {
              regStatus.textContent = '';
              regStatus.className = '';
            }

            if (progDropdown) {
              progDropdown.style.display = 'block';
              // Get current registration type (defaults to Individual for On Stage)
              const currentRegType = document.getElementById('reg-type')?.value || "Individual";
              fetchPrograms(currentCategory, currentRegType).catch(err => console.warn('Error loading programs:', err));
            }

            // Show reg-type only for On Stage
            const regTypeContainer = document.getElementById('reg-type-container');
            const groupNameContainer = document.getElementById('group-name-container');
            const typeInput = document.getElementById('reg-type');
            const typeText = document.getElementById('type-selected-text');
            const typeTrigger = document.getElementById('type-trigger');
            const regNameLabel = document.getElementById('reg-name-label');

            if (regTypeContainer) {
              if (title === "On Stage") {
                regTypeContainer.classList.remove('hidden');
                // Reset to Individual
                if (typeInput) typeInput.value = "Individual";
                if (typeText) typeText.textContent = "Individual";
                if (groupNameContainer) groupNameContainer.classList.add('hidden');
                if (regNameLabel) regNameLabel.textContent = "Full Name";
              } else {
                regTypeContainer.classList.add('hidden');
                if (groupNameContainer) groupNameContainer.classList.add('hidden');
                if (regNameLabel) regNameLabel.textContent = "Full Name";
              }
            }
          });
        });

        // Leaderboard Logic
        // leaderboardListener moved to top

        const openLeaderboard = () => {
          if (leaderboardModal) leaderboardModal.style.display = 'flex';

          if (!leaderboardListener) {
            console.log(`Starting Leaderboard Listener for ${systemYear}...`);
            const q = query(collection(db, "leaderboard"),
              where("academicYear", "==", systemYear),
              orderBy("score", "desc")
            );

            leaderboardListener = onSnapshot(q, (snapshot) => {
              if (snapshot.empty) {
                leaderboardContent.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-secondary);">No scores yet.</div>';
                return;
              }

              let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
              const leaderboardMap = new Map();
              snapshot.forEach(doc => {
                const data = doc.data();
                const deptName = data.department || doc.id;
                const score = data.score || 0;
                const docId = doc.id;

                const isOfficialId = docId === `${deptName}_${systemYear}`;

                if (!leaderboardMap.has(deptName) || isOfficialId) {
                  leaderboardMap.set(deptName, {
                    id: docId,
                    department: deptName,
                    score: score
                  });
                }
              });

              const leaderboardData = Array.from(leaderboardMap.values());

              leaderboardData.forEach((data, index) => {
                const score = data.score;
                const rank = index + 1;

                // Check for tie
                const isTie = (index > 0 && leaderboardData[index - 1].score === score) ||
                  (index < leaderboardData.length - 1 && leaderboardData[index + 1].score === score);

                const rankColor = rank === 1 ? "#ffd700" : rank === 2 ? "#c0c0c0" : rank === 3 ? "#cd7f32" : "rgba(255,255,255,0.5)";
                const rankLabel = isTie ? "TIE" : `#${rank}`;

                html += `
                  <div class="leaderboard-entry" onclick="showPointDetails('${(data.department || data.id).replace(/'/g, "\\'")}', ${score})" style="display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 1.25rem 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 0.5rem; gap: 1rem; cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: var(--font-heading); font-weight: 800; font-size: 1.25rem; min-width: 55px; color: ${rankColor};">${rankLabel}</div>
                    <div style="flex: 1; font-weight: 500; font-size: 1rem; line-height: 1.3; color: white;">${escapeHtml(data.department || data.id)}</div>
                    <div style="font-family: var(--font-heading); font-weight: 800; font-size: 1.5rem; background: var(--gradient-main); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; min-width: 45px; text-align: right;">${score}</div>
                  </div>
                `;
              });

              html += '</div>';
              leaderboardContent.innerHTML = html;
            }, (error) => {
              console.error("Leaderboard Listener Error:", error);
              leaderboardContent.innerHTML = '<div style="padding:2rem; text-align:center; color:#ef4444;">Error loading scores.</div>';
            });
          }
        };


        const closeLeaderboard = () => {
          if (leaderboardModal) leaderboardModal.style.display = 'none';
        };

        if (leaderboardBtn) leaderboardBtn.addEventListener('click', openLeaderboard);
        if (closeLeaderboardBtn) closeLeaderboardBtn.addEventListener('click', closeLeaderboard);
        if (leaderboardModal) leaderboardModal.addEventListener('click', (e) => {
          if (e.target === leaderboardModal) closeLeaderboard();
        });

        // Dropdown Logic (Refactored for Event Delegation)
        document.addEventListener('click', (e) => {
          // 1. Handle Trigger Click (Open/Close)
          const trigger = e.target.closest('.custom-dropdown-trigger');
          if (trigger) {
            const container = trigger.closest('.custom-dropdown-container');
            const menu = container.querySelector('.custom-dropdown-menu');

            e.stopPropagation();

            // Close all other dropdowns
            document.querySelectorAll('.custom-dropdown-menu').forEach(m => {
              if (m !== menu) m.classList.remove('show');
            });
            document.querySelectorAll('.custom-dropdown-trigger').forEach(t => {
              if (t !== trigger) t.classList.remove('active');
            });

            menu.classList.toggle('show');
            trigger.classList.toggle('active');
            return;
          }

          // 2. Handle Item Click (Selection)
          const item = e.target.closest('.custom-dropdown-item');
          if (item) {
            const container = item.closest('.custom-dropdown-container');
            if (container) {
              const trigger = container.querySelector('.custom-dropdown-trigger');
              const input = container.querySelector('input[type="hidden"]');
              const textSpan = trigger.querySelector('span:first-child');

              e.stopPropagation();
              input.value = item.getAttribute('data-value');
              textSpan.textContent = item.textContent;
              trigger.classList.add('has-value');

              const menu = container.querySelector('.custom-dropdown-menu');
              menu.classList.remove('show');
              trigger.classList.remove('active');

              // Visual feedback
              textSpan.style.color = "white";

              // Trigger change event for listeners
              input.dispatchEvent(new Event('change', { bubbles: true }));
            }
            return;
          }

          // 3. Handle Outside Click (Close)
          document.querySelectorAll('.custom-dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
          });
          document.querySelectorAll('.custom-dropdown-trigger').forEach(trigger => {
            trigger.classList.remove('active');
          });
        });

        // Deprecated helper but kept simple for initial setup if needed elsewhere
        function setupDropdown(triggerId, menuId, inputId, textId) {
          // Now handled by global event delegation based on classes
        }

        setupDropdown('dept-trigger', 'dept-menu', 'reg-dept', 'dept-selected-text');
        setupDropdown('year-trigger', 'year-menu', 'reg-year', 'year-selected-text');
        setupDropdown('gender-trigger', 'gender-menu', 'reg-gender', 'gender-selected-text');
        setupDropdown('prog-trigger', 'prog-menu', 'reg-program', 'prog-selected-text');
        setupDropdown('type-trigger', 'type-menu', 'reg-type', 'type-selected-text');

        // Monitor reg-type change
        const regTypeInput = document.getElementById('reg-type');
        if (regTypeInput) {
          let lastType = regTypeInput.value;
          setInterval(() => {
            if (regTypeInput.value !== lastType) {
              lastType = regTypeInput.value;
              const groupContainer = document.getElementById('group-name-container');
              const genderContainer = document.getElementById('gender-selection-container');
              const rollContainer = document.getElementById('roll-number-selection-container');
              const yearContainer = document.getElementById('year-selection-container');
              const membersContainer = document.getElementById('group-members-container');
              const nameInput = document.getElementById('reg-name');
              const groupInput = document.getElementById('reg-group-name');
              const rollInput = document.getElementById('reg-roll');
              const yearInput = document.getElementById('reg-year');
              const genderInput = document.getElementById('reg-gender');

              if (lastType === "Group") {
                if (groupContainer) groupContainer.classList.remove('hidden');
                if (genderContainer) genderContainer.classList.add('hidden');
                if (rollContainer) rollContainer.classList.add('hidden');
                if (yearContainer) yearContainer.classList.add('hidden');
                if (membersContainer) membersContainer.classList.remove('hidden');
                // Hide name field for groups
                if (nameInput) {
                  nameInput.parentElement.classList.add('hidden');
                  nameInput.required = false;
                  nameInput.value = "";
                }
                if (groupInput) groupInput.required = true;
                // Toggle required for hidden fields
                if (rollInput) rollInput.required = false;
                if (yearInput) yearInput.required = false;
                if (genderInput) genderInput.required = false;

                // Auto-add first member row if empty
                if (membersList && membersList.children.length === 0) {
                  membersList.appendChild(createMemberRow());
                  updateMemberCount();
                }
              } else {
                if (groupContainer) groupContainer.classList.add('hidden');
                if (genderContainer) genderContainer.classList.remove('hidden');
                if (rollContainer) rollContainer.classList.remove('hidden');
                if (yearContainer) yearContainer.classList.remove('hidden');
                if (membersContainer) membersContainer.classList.add('hidden');
                // Show name field for individuals
                if (nameInput) {
                  nameInput.parentElement.classList.remove('hidden');
                  nameInput.required = true;
                }
                if (groupInput) {
                  groupInput.required = false;
                  groupInput.value = "";
                }
                // Toggle required for visible fields
                if (rollInput) rollInput.required = true;
                if (yearInput) yearInput.required = true;
                if (genderInput) genderInput.required = true;

                // Clear members if switching back to Individual
                const membersListRef = document.getElementById('members-list');
                if (membersListRef) membersListRef.innerHTML = '';
                updateMemberCount();
              }

              // Refresh programs dropdown if On Stage is selected
              if (currentCategory === "On Stage") {
                fetchPrograms("On Stage", lastType).catch(err => console.warn('Error loading programs:', err));
              }
            }
          }, 200);
        }

        // Group Members Logic
        const addMemberBtn = document.getElementById('add-member-btn');
        const membersList = document.getElementById('members-list');
        const memberCountSpan = document.getElementById('member-count');

        const updateMemberCount = () => {
          if (!memberCountSpan || !membersList) return;
          const count = membersList.querySelectorAll('.member-row').length;
          memberCountSpan.textContent = `${count} ${count === 1 ? 'Member' : 'Members'}`;
        };

        const createMemberRow = () => {
          const div = document.createElement('div');
          div.className = 'member-row';
          div.style.cssText = "display: flex; gap: 0.5rem; align-items: center; width: 100%; animation: fadeIn 0.3s ease-out;";
          div.innerHTML = `
            <input type="text" class="form-input member-name" placeholder="Member Name" required style="flex: 2; box-sizing: border-box; text-transform: uppercase; font-size: 0.8rem; padding: 0.6rem;">
            <input type="text" class="form-input member-roll" placeholder="Roll No" required style="flex: 1; box-sizing: border-box; text-transform: uppercase; font-size: 0.8rem; padding: 0.6rem;">
            <div class="custom-dropdown-container" style="flex: 1; min-width: 100px;">
              <input type="hidden" class="member-year" value="1" required>
              <div class="custom-dropdown-trigger has-value" style="padding: 0.6rem; font-size: 0.8rem; border-radius: 0.75rem;">
                <span class="member-year-text" style="color: white;">1st Year</span>
                <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div class="custom-dropdown-menu" style="max-height: 200px;">
                <div class="custom-dropdown-item" data-value="1">1st Year</div>
                <div class="custom-dropdown-item" data-value="2">2nd Year</div>
                <div class="custom-dropdown-item" data-value="3">3rd Year</div>
                <div class="custom-dropdown-item" data-value="4">4th Year</div>
              </div>
            </div>
            <button type="button" class="remove-member-btn" style="background: rgba(239, 68, 68, 0.1); border: none; color: #ef4444; cursor: pointer; border-radius: 0.5rem; width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.2s;">
              <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
            </button>
          `;

          // Handle uppercase enforcement for member name
          const nameInput = div.querySelector('.member-name');
          if (nameInput) {
            nameInput.addEventListener('input', () => {
              nameInput.value = nameInput.value.toUpperCase();
            });
          }

          // Handle removal
          div.querySelector('.remove-member-btn').addEventListener('click', () => {
            div.style.opacity = '0';
            div.style.transform = 'translateX(10px)';
            setTimeout(() => {
              div.remove();
              updateMemberCount();
            }, 300);
          });

          return div;
        };

        if (addMemberBtn && membersList) {
          addMemberBtn.addEventListener('click', () => {
            membersList.appendChild(createMemberRow());
            updateMemberCount();
            // Scroll to bottom of list
            membersList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
          });
        }

        // Dropdowns are initialized, custom population handled by dynamic listeners
        setupDropdown('filter-year-trigger', 'filter-year-menu', 'filter-reg-year', 'filter-year-text');
        setupDropdown('filter-dept-trigger', 'filter-dept-menu', 'filter-reg-department', 'filter-dept-text');
        setupDropdown('filter-item-trigger', 'filter-item-menu', 'filter-reg-item', 'filter-item-text');
        setupDropdown('filter-date-trigger', 'filter-date-menu', 'filter-reg-date', 'filter-date-text');

        // Add change listeners for filters
        const filterYearInput = document.getElementById('filter-reg-year');
        const filterDeptInput = document.getElementById('filter-reg-department');
        const filterItemInput = document.getElementById('filter-reg-item');

        const handleFilterChange = () => {
          filterAndDisplayRegistrations();
        };

        // We need an interval because custom dropdown might update the hidden input value
        // but not trigger 'change' event.
        if (filterYearInput) {
          let lastYear = filterYearInput.value;
          setInterval(() => {
            if (filterYearInput.value !== lastYear) {
              lastYear = filterYearInput.value;
              handleFilterChange();
            }
          }, 500);
        }

        if (filterDeptInput) {
          let lastDept = filterDeptInput.value;
          setInterval(() => {
            if (filterDeptInput.value !== lastDept) {
              lastDept = filterDeptInput.value;
              handleFilterChange();
            }
          }, 500);
        }

        if (filterItemInput) {
          let lastItem = filterItemInput.value;
          setInterval(() => {
            if (filterItemInput.value !== lastItem) {
              lastItem = filterItemInput.value;
              handleFilterChange();
            }
          }, 500);
        }

        const filterDateInput = document.getElementById('filter-reg-date');
        if (filterDateInput) {
          let lastDate = filterDateInput.value;
          setInterval(() => {
            if (filterDateInput.value !== lastDate) {
              lastDate = filterDateInput.value;
              handleFilterChange();
            }
          }, 500);
        }

        // Admin Access Shortcut (Triple Tap on "College Arts Day")
        const heroTitle = document.querySelector('h1.logo-title');
        if (heroTitle) {
          let tapCount = 0;
          let tapTimer = null;

          heroTitle.addEventListener('click', () => {
            clearTimeout(tapTimer);
            tapTimer = setTimeout(() => {
              tapCount = 0;
            }, 800);

            tapCount++;

            if (tapCount === 3) {
              console.log("Admin Shortcut Activated!");
              try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
              } catch (e) {
                console.error("Audio play failed", e);
              }
              setTimeout(() => {
                window.location.replace('https://unionartsprcadmin.web.app');
              }, 400);
              tapCount = 0;
            }
          });
          heroTitle.style.cursor = "pointer";
          heroTitle.title = "???";
        }

        // SECRET CORE ACCESS (5 clicks on any Logo)
        const allLogos = document.querySelectorAll('.logo, .footer-logo');
        let logoClickCount = 0;
        let logoClickTimer = null;

        const playSecretSound = async () => {
          try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            const playTone = (freq, start, duration, type = 'square', volume = 0.1) => {
              const osc = audioCtx.createOscillator();
              const gain = audioCtx.createGain();
              osc.type = type;
              osc.frequency.setValueAtTime(freq, audioCtx.currentTime + start);
              gain.gain.setValueAtTime(volume, audioCtx.currentTime + start);
              gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + start + duration);
              osc.connect(gain);
              gain.connect(audioCtx.destination);
              osc.start(audioCtx.currentTime + start);
              osc.stop(audioCtx.currentTime + start + duration);
            };

            // Sequence: Charge up -> Mechanical Clunk -> System Access
            for (let i = 0; i < 5; i++) playTone(200 + (i * 100), i * 0.1, 0.1, 'sawtooth', 0.05);
            playTone(100, 0.6, 0.4, 'sine', 0.2); // Low thud
            playTone(880, 1.0, 0.2, 'square', 0.1); // Success beep
            playTone(1760, 1.1, 0.3, 'square', 0.1); // High success
          } catch (e) { }
        };

        allLogos.forEach(logo => {
          logo.style.cursor = 'pointer';
          logo.addEventListener('click', (e) => {
            e.preventDefault();
            clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => {
              logoClickCount = 0;
            }, 2000);

            logoClickCount++;

            if (logoClickCount === 5) {
              logoClickCount = 0;
              document.body.style.transition = "opacity 0.5s ease";
              document.body.style.opacity = "0";
              try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
              } catch (e) { }
              setTimeout(() => {
                window.location.replace('https://unionartsprccoreadmin.web.app');
              }, 500);
            }
          });
        });

        // Fetch Programs
        async function fetchPrograms(category, regType) {
          try {
            if (!progMenu) return;
            if (progSelectedText) {
              progSelectedText.textContent = "Select Program / Item";
              progSelectedText.style.color = "";
            }
            if (progInput) progInput.value = "";
            if (progTrigger) progTrigger.classList.remove('has-value');

            // Get dynamic custom programs from Firestore
            const dynamicPrograms = Object.values(programDates)
              .filter(p => p.isCustom && p.category === category)
              .map(p => p.programName);

            let eventsToShow = [];

            if (category === "Off Stage") {
              eventsToShow = [...OFF_STAGE_EVENTS, ...dynamicPrograms];
            } else if (category === "On Stage") {
              if (regType === "Individual") {
                eventsToShow = [...ON_STAGE_INDIVIDUAL_EVENTS, ...dynamicPrograms];
              } else if (regType === "Group") {
                eventsToShow = [...ON_STAGE_GROUP_EVENTS, ...dynamicPrograms];
              } else {
                eventsToShow = [...ON_STAGE_EVENTS, ...dynamicPrograms];
              }
            }

            // Remove duplicates and sort
            const finalProgramList = [...new Set(eventsToShow)].sort();

            if (finalProgramList.length > 0) {
              let html = '';
              finalProgramList.forEach(item => {
                html += `<div class="custom-dropdown-item" data-value="${item}">${item}</div>`;
              });
              progMenu.innerHTML = html;
            } else {
              progMenu.innerHTML = '<div class="custom-dropdown-item" data-value="General Entry">General Entry</div>';
            }
          } catch (error) {
            console.warn('Error in fetchPrograms:', error);
            // Fallback to static list if there's an error
            if (progMenu) {
              progMenu.innerHTML = '<div class="custom-dropdown-item" data-value="General Entry">General Entry</div>';
            }
          }
        }

        // Close Modal
        function closeAll() {
          if (regModal) regModal.style.display = 'none';
          document.querySelectorAll('.custom-dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        if (closeModalBtn) closeModalBtn.addEventListener('click', closeAll);
        if (regModal) regModal.addEventListener('click', (e) => {
          if (e.target === regModal) closeAll();
        });

        // Submit
        if (regForm) regForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const regStatus = document.getElementById('reg-status');
          const btn = regForm.querySelector('button[type="submit"]');

          try {
            if (regStatus) regStatus.textContent = "Checking connection...";
            await validateConnection();

            const name = document.getElementById('reg-name').value;
            const dept = document.getElementById('reg-dept').value;
            const roll = document.getElementById('reg-roll').value;
            const year = document.getElementById('reg-year').value;
            const phone = document.getElementById('reg-phone').value;
            const regType = document.getElementById('reg-type')?.value || "Individual";
            const program = document.getElementById('reg-program').value;
            const gender = document.getElementById('reg-gender').value;

            const membersCount = regType === "Group" ? document.querySelectorAll('.member-row').length : 0;
            if (!dept || !phone || !program || (regType === "Individual" && (!name || !gender || !roll || !year)) || (regType === "Group" && (!document.getElementById('reg-group-name')?.value || membersCount === 0))) {
              if (regStatus) {
                regStatus.textContent = regType === "Group" && membersCount === 0 ? "Please add at least one group member." : "Please fill all fields.";
                regStatus.style.color = "#ef4444";
              }
              return;
            }

            if (regStatus) {
              regStatus.textContent = "Registering...";
              regStatus.style.color = "var(--text-secondary)";
            }
            if (btn) btn.disabled = true;

            const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Request timed out. Server might be busy or unreachable.")), 15000));

            const groupMembers = [];
            if (regType === "Group") {
              const rows = document.querySelectorAll('.member-row');
              rows.forEach(row => {
                const mName = row.querySelector('.member-name').value;
                const mRoll = row.querySelector('.member-roll').value;
                const mYear = row.querySelector('.member-year').value;
                if (mName) groupMembers.push({ name: mName, roll: mRoll, year: mYear });
              });
            }

            const regData = {
              category: currentCategory || "Unknown",
              studentName: name,
              department: dept,
              rollNumber: roll,
              year: year,
              phone: phone,
              gender: gender,
              program: program || "General",
              regType: regType,
              academicYear: systemYear, // Inject active year
              groupName: document.getElementById('reg-group-name')?.value || "",
              groupMembers: groupMembers,
              registeredBy: (auth.currentUser?.email || "guest").toLowerCase(),
              registeredAt: new Date().toISOString()
            };

            await Promise.race([
              addDoc(collection(db, "registrations"), regData),
              timeout
            ]);

            if (regStatus) {
              regStatus.textContent = "Registration Successful!";
              regStatus.style.color = "#10b981";
            }

            if (successDetails) {
              const yearText = year === "1" ? "1st Year" : year === "2" ? "2nd Year" : year === "3" ? "3rd Year" : year === "4" ? "4th Year" : year;
              let successHtml = '';
              if (regData.regType !== "Group") {
                successHtml += `<div class="success-detail-row"><span class="success-detail-label">Name</span><span class="success-detail-value">${name}</span></div>`;
              }
              successHtml += `<div class="success-detail-row"><span class="success-detail-label">Category</span><span class="success-detail-value">${currentCategory}</span></div>`;
              if (regData.regType === "Group") {
                successHtml += `
                  <div class="success-detail-row" style="flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                    <span class="success-detail-label">Group Details</span>
                    <div style="width: 100%; background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.25rem;">
                      <div style="color: var(--accent-primary); font-weight: 700; margin-bottom: 0.5rem; font-size: 0.9rem;">${regData.groupName}</div>
                      <div style="display: grid; gap: 0.25rem; font-size: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.5rem;">
                        <div style="color: var(--text-secondary); font-weight: 600;">Members:</div>
                        ${regData.groupMembers.map(m => {
                  const mYearText = m.year === "1" ? "1st Year" : m.year === "2" ? "2nd Year" : m.year === "3" ? "3rd Year" : m.year === "4" ? "4th Year" : m.year;
                  return `<div>\u2022 ${m.name} ${m.roll ? `(${m.roll})` : ''} - ${mYearText}</div>`;
                }).join('')}
                      </div>
                    </div>
                  </div>`;
              }
              successHtml += `
                <div class="success-detail-row"><span class="success-detail-label">Program</span><span class="success-detail-value">${program}</span></div>
                <div class="success-detail-row"><span class="success-detail-label">Department</span><span class="success-detail-value">${dept}</span></div>
              `;
              if (regData.regType !== "Group") {
                successHtml += `<div class="success-detail-row"><span class="success-detail-label">Year</span><span class="success-detail-value">${yearText}</span></div>`;
                successHtml += `<div class="success-detail-row"><span class="success-detail-label">Roll No</span><span class="success-detail-value">${roll}</span></div>`;
              }
              successDetails.innerHTML = successHtml;
            }

            closeAll();
            if (successModal) successModal.style.display = 'flex';
            regForm.reset();
            document.querySelectorAll('.custom-dropdown-trigger').forEach(t => {
              t.classList.remove('has-value');
              const textSpan = t.querySelector('span:first-child');
              if (textSpan) {
                if (t.id === 'dept-trigger') textSpan.textContent = "Select Course";
                if (t.id === 'year-trigger') textSpan.textContent = "Select Year";
                if (t.id === 'gender-trigger') textSpan.textContent = "Select Gender";
                if (t.id === 'prog-trigger') textSpan.textContent = "Select Program / Item";
                if (t.id === 'type-trigger') textSpan.textContent = "Individual";
              }
            });
          } catch (error) {
            console.error("Registration Error:", error);
            if (regStatus) {
              if (error.code === 'permission-denied') {
                regStatus.textContent = "Error: Registration closed or not authorized.";
              } else {
                regStatus.textContent = "Error: " + error.message;
              }
              regStatus.style.color = "#ef4444";
            }
          } finally {
            if (btn) btn.disabled = false;
          }
        });

        if (closeSuccessBtn) {
          closeSuccessBtn.addEventListener('click', () => {
            if (successModal) successModal.style.display = 'none';
          });
        }
        if (successModal) {
          successModal.addEventListener('click', (e) => {
            if (e.target === successModal) successModal.style.display = 'none';
          });
        }


        // My Registrations Section - Fetch and Display
        const registrationsContainer = document.getElementById('registrations-container');
        let registrationsListener = null;
        let allUserRegistrations = []; // Local cache for filtering
        let allScoreLogs = []; // Global cache for achievements
        let categoryFilter = 'all'; // 'all', 'On Stage', 'Off Stage'
        let programDates = {};

        function updateItemFilterDropdown(registrations) {
          const filterItemMenu = document.getElementById('filter-item-menu');
          if (!filterItemMenu) return;

          // Extract unique programs that actually exist in the registrations
          const uniqueItems = [...new Set(registrations.map(reg => reg.program).filter(Boolean))].sort();

          let html = '<div class="custom-dropdown-item" data-value="">All Items</div>';
          uniqueItems.forEach(item => {
            html += `<div class="custom-dropdown-item" data-value="${item}">${item}</div>`;
          });

          filterItemMenu.innerHTML = html;

          // If current selected filter is NOT in the new list, reset to 'All'
          const filterItemInput = document.getElementById('filter-reg-item');
          if (filterItemInput && filterItemInput.value && !uniqueItems.includes(filterItemInput.value)) {
            filterItemInput.value = "";
            const filterItemText = document.getElementById('filter-item-text');
            const filterItemTrigger = document.getElementById('filter-item-trigger');
            if (filterItemText) filterItemText.textContent = "All Items";
            if (filterItemTrigger) filterItemTrigger.classList.remove('has-value');
          }
        }

        function updateCourseFilterDropdown(registrations) {
          const filterDeptMenu = document.getElementById('filter-dept-menu');
          if (!filterDeptMenu) return;

          // Extract unique departments/courses that actually exist in the registrations
          const uniqueCourses = [...new Set(registrations.map(reg => reg.department).filter(Boolean))].sort();

          let html = '';
          if (uniqueCourses.length > 1 || isFirestoreAdmin) {
            html += '<div class="custom-dropdown-item" data-value="">All Courses</div>';
          }

          uniqueCourses.forEach(course => {
            html += `<div class="custom-dropdown-item" data-value="${course}">${course}</div>`;
          });

          filterDeptMenu.innerHTML = html;

          // Handle selection state
          const filterDeptInput = document.getElementById('filter-reg-department');
          const filterDeptText = document.getElementById('filter-dept-text');
          const filterDeptTrigger = document.getElementById('filter-dept-trigger');

          if (filterDeptInput && filterDeptInput.value && !uniqueCourses.includes(filterDeptInput.value)) {
            // Reset if old selection gone
            filterDeptInput.value = "";
            if (filterDeptText) filterDeptText.textContent = uniqueCourses.length > 1 ? "All Courses" : "Select Course";
            if (filterDeptTrigger) filterDeptTrigger.classList.remove('has-value');
          } else if (filterDeptInput && !filterDeptInput.value && uniqueCourses.length === 1) {
            // Auto-select if only one available and nothing selected
            const onlyCourse = uniqueCourses[0];
            filterDeptInput.value = onlyCourse;
            if (filterDeptText) {
              filterDeptText.textContent = onlyCourse;
              filterDeptText.style.color = "white";
            }
            if (filterDeptTrigger) filterDeptTrigger.classList.add('has-value');
          }
        }

        async function fetchProgramDates() {
          try {
            const q = query(collection(db, "program_dates"), where("academicYear", "==", systemYear));
            const querySnapshot = await getDocs(q);
            programDates = {};
            querySnapshot.forEach((doc) => {
              programDates[doc.id] = doc.data();
            });

            // Populate filter date dropdown
            const filterDateMenu = document.getElementById('filter-date-menu');
            if (filterDateMenu) {
              const allScheduledDates = Object.values(programDates).map(d => d.date).filter(Boolean);
              const uniqueFullDates = [...new Set(allScheduledDates)].sort();

              // Extract unique date parts (e.g., "Jan 16")
              const uniqueDateParts = [...new Set(allScheduledDates.map(d => d.split(',')[0]))].sort();

              let html = '<div class="custom-dropdown-item" data-value="all">All Dates</div>';

              // Add date-only options first
              uniqueDateParts.forEach(datePart => {
                html += `<div class="custom-dropdown-item date-only-group" data-value="${datePart}" style="background: rgba(217, 70, 239, 0.05); font-weight: 700;">${datePart} (All Day)</div>`;
              });

              // Add full date-time options
              uniqueFullDates.forEach(date => {
                html += `<div class="custom-dropdown-item" data-value="${date}">${date}</div>`;
              });

              filterDateMenu.innerHTML = html;
            }

            if (allUserRegistrations.length > 0) displayRegistrations(allUserRegistrations);
          } catch (error) {
            console.error("Error fetching dates:", error);
          }
        }

        // Initial fetch
        fetchProgramDates().catch(err => console.warn('Error loading program dates:', err));

        function formatDate(isoString) {
          if (!isoString) return 'N/A';
          const date = new Date(isoString);
          const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          };
          return date.toLocaleDateString('en-US', options);
        }

        function filterAndDisplayRegistrations() {
          const yearFilter = document.getElementById('filter-reg-year')?.value || 'all';
          const deptFilter = document.getElementById('filter-reg-department')?.value || '';
          const itemFilter = (document.getElementById('filter-reg-item')?.value || '').toLowerCase();
          const dateFilter = document.getElementById('filter-reg-date')?.value || 'all';

          const filtered = allUserRegistrations.filter(reg => {
            const matchesYear = yearFilter === 'all' || String(reg.year) === String(yearFilter);
            const matchesDept = !deptFilter || reg.department === deptFilter;
            const matchesCategory = categoryFilter === 'all' || reg.category === categoryFilter;
            const matchesItem = !itemFilter ||
              (reg.program && reg.program.toLowerCase().includes(itemFilter)) ||
              (reg.studentName && reg.studentName.toLowerCase().includes(itemFilter));

            const regProgramDate = programDates[reg.program]?.date;
            // Match if dateFilter is 'all', or exact match, or if regProgramDate starts with dateFilter (for date-only selection)
            const matchesDate = dateFilter === 'all' ||
              regProgramDate === dateFilter ||
              (regProgramDate && regProgramDate.startsWith(dateFilter + ','));

            return matchesYear && matchesDept && matchesItem && matchesCategory && matchesDate;
          });

          // Update Total Count Badge
          const totalFilteredCountElem = document.getElementById('count-filtered-total');
          if (totalFilteredCountElem) {
            totalFilteredCountElem.textContent = filtered.length;
          }

          displayRegistrations(filtered);
        }

        // Toggle Category Filter Logic
        const btnFilterOnStage = document.getElementById('btn-filter-on-stage');
        const btnFilterOffStage = document.getElementById('btn-filter-off-stage');

        function updateCategoryFilterUI() {
          // Reset both
          if (btnFilterOnStage) {
            btnFilterOnStage.classList.remove('active', 'dimmed');
          }
          if (btnFilterOffStage) {
            btnFilterOffStage.classList.remove('active', 'dimmed');
          }

          if (categoryFilter === 'On Stage') {
            if (btnFilterOnStage) btnFilterOnStage.classList.add('active');
            if (btnFilterOffStage) btnFilterOffStage.classList.add('dimmed');
          } else if (categoryFilter === 'Off Stage') {
            if (btnFilterOffStage) btnFilterOffStage.classList.add('active');
            if (btnFilterOnStage) btnFilterOnStage.classList.add('dimmed');
          }
        }

        if (btnFilterOnStage) {
          btnFilterOnStage.addEventListener('click', () => {
            if (categoryFilter === 'On Stage') {
              categoryFilter = 'all';
            } else {
              categoryFilter = 'On Stage';
            }
            updateCategoryFilterUI();
            filterAndDisplayRegistrations();
          });
        }

        if (btnFilterOffStage) {
          btnFilterOffStage.addEventListener('click', () => {
            if (categoryFilter === 'Off Stage') {
              categoryFilter = 'all';
            } else {
              categoryFilter = 'Off Stage';
            }
            updateCategoryFilterUI();
            filterAndDisplayRegistrations();
          });
        }

        function displayRegistrations(registrations) {
          if (!registrationsContainer) return;

          if (registrations.length === 0) {
            const hasActiveFilters = (document.getElementById('filter-reg-year')?.value !== 'all') ||
              (document.getElementById('filter-reg-item')?.value !== '');

            registrationsContainer.innerHTML = `
                      <div class="reg-empty-state">
                        <div class="reg-empty-icon">${hasActiveFilters ? '\uD83D\uDD0D' : '\uD83D\uDCCB'}</div>
                        <div class="reg-empty-text">${hasActiveFilters ? 'No matches found' : 'No registrations yet'}</div>
                        <div class="reg-empty-subtext">${hasActiveFilters ? 'Try adjusting your filters' : 'Students you register will appear here'}</div>
                      </div>
                      `;
            return;
          }

          let html = '';
          registrations.forEach(reg => {
            const yearText = reg.year === "1" ? "1st Year" :
              reg.year === "2" ? "2nd Year" :
                reg.year === "3" ? "3rd Year" :
                  reg.year === "4" ? "4th Year" : reg.year;

            const categoryClass = reg.category === "On Stage" ? "on-stage" : "off-stage";

            // Check for achievement
            const achievement = allScoreLogs.find(log => {
              const logItem = (log.itemName || "").trim().toLowerCase();
              const regItem = (reg.program || "").trim().toLowerCase();
              const logName = (log.participantName || "").trim().toLowerCase();
              const regName = (reg.regType === "Group" ? (reg.groupName || "") : (reg.studentName || "")).trim().toLowerCase();

              const matches = logItem === regItem &&
                logName === regName &&
                (log.position === "1st" || log.position === "2nd" || log.position === "3rd");

              if (matches) {
                console.log('[Achievement Match Found]', {
                  regProgram: reg.program,
                  regName: reg.regType === "Group" ? reg.groupName : reg.studentName,
                  logItem: log.itemName,
                  logName: log.participantName,
                  position: log.position,
                  points: log.points
                });
              }

              return matches;
            });

            let achievementBadgeHtml = '';
            let viewResultBtnHtml = '';

            if (achievement) {
              console.log('[Creating Badge]', achievement);
              const posClass = achievement.position === "1st" ? "first" : achievement.position === "2nd" ? "second" : "third";
              const posLabel = achievement.position === "1st" ? "1st" : achievement.position === "2nd" ? "2nd" : "3rd";
              const posIcon = achievement.position === "1st" ? "🏆" : achievement.position === "2nd" ? "🥈" : "🥉";
              // Removed points text from badge as per request
              achievementBadgeHtml = `<div class="achievement-badge ${posClass}">${posIcon} ${posLabel} PLACE</div>`;

              // Prepare data for popup (sanitize strings for onclick)
              const safeProgram = (reg.program || "Event").replace(/'/g, "\\'");
              const safePosition = achievement.position;
              const safePoints = achievement.points || 0;

              viewResultBtnHtml = `
                      <button class="view-result-btn ${posClass}" onclick="showResultPopup('${safeProgram}', '${safePosition}', '${safePoints}')">
                        <i class="fas fa-trophy"></i> View Points
                      </button>
                      `;
            } else {
              // Debug: Log when no achievement found
              console.log('[No Achievement]', {
                regProgram: reg.program,
                regName: reg.regType === "Group" ? reg.groupName : reg.studentName,
                totalScoreLogs: allScoreLogs.length
              });
            }

            html += `
                      <div class="registration-card" ${reg.isCanceled ? 'style="opacity: 0.8; border-color: rgba(239, 68, 68, 0.3);"' : ''}>
                        <div class="reg-card-header">
                          <div>
                            <h3 class="reg-student-name">
                              ${escapeHtml(reg.groupName || reg.studentName || 'N/A')}
                              ${reg.isCanceled ? `<span style="font-size: 0.65rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 4px; margin-left: 8px; border: 1px solid rgba(239, 68, 68, 0.2); vertical-align: middle;">CANCELED</span>` : ''}
                            </h3>
                            ${!achievement && programDates[reg.program]?.date ?
                `<div style="font-size: 0.8rem; color: var(--accent-secondary); margin-top: 0.5rem; font-weight: 500; line-height: 1.4;">
                           <div><i class="fas fa-calendar-alt" style="margin-right: 0.25rem;"></i> ${programDates[reg.program].date}</div>
                           ${programDates[reg.program]?.stage ? `<div style="margin-top: 0.15rem;"><i class="fas fa-layer-group" style="margin-right: 0.25rem;"></i> ${programDates[reg.program].stage}</div>` : ''}
                         </div>` : ''}
                          </div>
                            ${achievementBadgeHtml}
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.4rem;">
                                ${reg.chestNumber || reg.chessNumber ? `<div class="chest-badge-index"><i class="fas fa-chess-pawn"></i> CHEST: ${reg.chestNumber || reg.chessNumber}</div>` : ''}
                                <span class="reg-category-badge ${categoryClass}">${reg.category || 'N/A'}</span>
                            </div>
                        </div>

                        ${viewResultBtnHtml ? `<div style="margin-bottom: 1rem;">${viewResultBtnHtml}</div>` : ''}

                        <div class="reg-card-details">
                          <div class="reg-detail-row">
                            <span class="reg-detail-label">Department</span>
                            <span class="reg-detail-value">${reg.department || 'N/A'}</span>
                          </div>
                          <div class="reg-detail-row">
                            <span class="reg-detail-label">Roll Number</span>
                            <span class="reg-detail-value">${reg.rollNumber || 'N/A'}</span>
                          </div>
                          <div class="reg-detail-row">
                            <span class="reg-detail-label">Year</span>
                            <span class="reg-detail-value">${yearText}</span>
                          </div>
                          <div class="reg-detail-row">
                            <span class="reg-detail-label">Gender</span>
                            <span class="reg-detail-value">${reg.gender || 'N/A'}</span>
                          </div>
                          <div class="reg-detail-row">
                            <span class="reg-detail-label">Phone</span>
                            <span class="reg-detail-value">${reg.phone || 'N/A'}</span>
                          </div>
                          <div class="reg-program-highlight">
                            <div class="reg-detail-row">
                              <span class="reg-detail-label">Program/Item</span>
                              <span class="reg-detail-value">${escapeHtml(reg.program || 'N/A')}</span>
                            </div>
                          </div>
                        </div>
                        ${reg.regType === "Group" && reg.groupMembers && reg.groupMembers.length > 0 ? `
                <div class="reg-group-members-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                  ${reg.category === "On Stage" ? `
                    <button class="view-members-btn" onclick="toggleGroupMembers(this)" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 0.6rem 1rem; border-radius: 0.75rem; font-size: 0.85rem; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease; font-weight: 500;">
                      <i class="fas fa-users-viewfinder"></i> <span>View Group Members (${reg.groupMembers.length})</span> <i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-left: auto;"></i>
                    </button>
                    <div class="group-members-container" style="display: none; margin-top: 1rem; animation: fadeIn 0.3s ease;">
                  ` : `
                    <div class="group-members-container">
                  `}
                  
                    <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; font-weight: 600;">Group Members</div>
                    <div style="display: grid; gap: 0.4rem;">
                      ${reg.groupMembers.map(m => {
                  const mYearText = m.year === "1" ? "1st Yr" : m.year === "2" ? "2nd Yr" : m.year === "3" ? "3rd Yr" : m.year === "4" ? "4th Yr" : (m.year ? `${m.year} Yr` : '');
                  return `
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: white; background: rgba(255,255,255,0.03); padding: 0.4rem 0.75rem; border-radius: 0.5rem;">
                          <span>${escapeHtml(m.name)} ${mYearText ? `<span style="color: var(--accent-color); font-size: 0.75rem; margin-left: 0.5rem;">[${escapeHtml(mYearText)}]</span>` : ''}</span>
                          ${m.roll ? `<span style="color: var(--text-secondary); font-size: 0.75rem;">(${escapeHtml(m.roll)})</span>` : ''}
                        </div>
                      `;
                }).join('')}
                    </div>
                  </div>
                </div>
                ` : ''}

                        <button class="reg-action-toggle" onclick="toggleRegActions(this)">
                          <i class="fas fa-chevron-down"></i> Contact Student
                        </button>

                        <div class="reg-card-actions">
                          <a href="tel:${reg.phone}" class="reg-action-btn call-btn">
                            <i class="fas fa-phone-alt"></i> Call
                          </a>
                          <a href="https://wa.me/91${reg.phone}" target="_blank" class="reg-action-btn whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                          </a>
                          <a href="/appeal?name=${encodeURIComponent(reg.studentName || '')}&chest=${encodeURIComponent(reg.chestNumber || reg.chessNumber || '')}&dept=${encodeURIComponent(reg.department || '')}&program=${encodeURIComponent(reg.program || '')}&phone=${encodeURIComponent(reg.phone || '')}" 
                             class="reg-action-btn appeal-card-btn" 
                             style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex: 1; padding: 0.6rem; border-radius: 0.75rem; font-size: 0.8rem; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-gavel"></i> Appeal
                          </a>
                        </div>

                        <div class="reg-timestamp">Registered on ${formatDate(reg.registeredAt)}</div>
                      </div>
                      `;
          });

          registrationsContainer.innerHTML = html;
        }

        // New Result Popup Logic
        window.showResultPopup = (program, position, points) => {
          // Use SweetAlert2-style modal or custom modal
          // Since we already have customAlertModal, let's create a dedicated one or repurpose it
          // OR create a quick dynamic one

          const existingPopup = document.getElementById('result-popup-modal');
          if (existingPopup) existingPopup.remove();

          const posColor = position === "1st" ? "#ffd700" : position === "2nd" ? "#c0c0c0" : "#cd7f32";
          const posIcon = position === "1st" ? "\uD83C\uDFC6" : position === "2nd" ? "\uD83E\uDD48" : "\uD83E\uDD49";

          const popupHtml = `
                      <div id="result-popup-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 12000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease;">
                        <div style="background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; padding: 2.5rem; width: 90%; max-width: 400px; text-align: center; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); transform: scale(0.9); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;">
                          <button onclick="document.getElementById('result-popup-modal').remove()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>

                          <div style="font-size: 4rem; margin-bottom: 1rem; animation: float 3s ease-in-out infinite;">${posIcon}</div>

                          <h2 style="font-family: var(--font-heading); font-size: 2rem; margin-bottom: 0.5rem; color: ${posColor}; text-transform: uppercase;">${position} Place</h2>

                          <div style="font-size: 1.1rem; color: white; margin-bottom: 1.5rem; font-weight: 500;">
                            ${escapeHtml(program)}
                          </div>

                          <div style="background: rgba(255,255,255,0.05); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.1em; margin-bottom: 0.5rem;">Points Awarded</div>
                            <div style="font-size: 2.5rem; font-weight: 800; font-family: var(--font-heading); background: var(--gradient-main); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${points}</div>
                          </div>

                          <button onclick="document.getElementById('result-popup-modal').remove()" style="margin-top: 2rem; background: var(--gradient-main); border: none; padding: 0.8rem 2rem; border-radius: 2rem; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                            Awesome!
                          </button>
                        </div>
                      </div>
                      <style>
                        @keyframes popIn {
                          from { opacity: 0; transform: scale(0.9); }
                          to { opacity: 1; transform: scale(1); }
                        }
                        @keyframes float {
                          0%, 100% { transform: translateY(0); }
                          50% { transform: translateY(-10px); }
                        }
                      </style>
                      `;

          document.body.insertAdjacentHTML('beforeend', popupHtml);
        };

        // Results Summary Function
        window.showResultsSummary = () => {
          // Build winners data directly from score logs (which contain all public results)
          const winnersData = [];

          console.log('[Prize Winners] Total score logs loaded:', allScoreLogs.length);
          console.log('[Prize Winners] Sample score log:', allScoreLogs[0]);

          allScoreLogs.forEach(log => {
            console.log('[Prize Winners] Processing log:', log);
            // Only include logs with positions (1st, 2nd, 3rd)
            if (log.position === "1st" || log.position === "2nd" || log.position === "3rd") {
              winnersData.push({
                program: log.itemName || "Unknown",
                participant: log.participantName || "Unknown",
                department: log.department || "N/A",
                position: log.position,
                points: log.points || 0
              });
            }
          });

          console.log('[Prize Winners] Total winners found:', winnersData.length);
          console.log('[Prize Winners] Winners data:', winnersData);

          // Remove existing popup if any
          const existingPopup = document.getElementById('results-summary-modal');
          if (existingPopup) existingPopup.remove();

          // Create popup content
          let winnersHtml = '';
          if (winnersData.length === 0) {
            winnersHtml = `
              <div style="text-align: center; padding: 3rem 2rem; color: var(--text-secondary);">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">🏆</div>
                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No Prize Winners Yet</div>
                <div style="font-size: 0.9rem; opacity: 0.7;">Results will appear here once scores are awarded.</div>
              </div>
            `;
          } else {
            // Sort by position (1st, 2nd, 3rd) then by points
            winnersData.sort((a, b) => {
              const posOrder = { "1st": 1, "2nd": 2, "3rd": 3 };
              if (posOrder[a.position] !== posOrder[b.position]) {
                return posOrder[a.position] - posOrder[b.position];
              }
              return (b.points || 0) - (a.points || 0);
            });

            winnersHtml = winnersData.map(winner => {
              const posColor = winner.position === "1st" ? "#ffd700" : winner.position === "2nd" ? "#c0c0c0" : "#cd7f32";
              const posIcon = winner.position === "1st" ? "🏆" : winner.position === "2nd" ? "🥈" : "🥉";
              const posClass = winner.position === "1st" ? "first" : winner.position === "2nd" ? "second" : "third";

              return `
                      <div class="winner-item ${posClass}" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-left: 4px solid ${posColor}; padding: 1.25rem; border-radius: 0.75rem; transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                          <div style="flex: 1;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">${escapeHtml(winner.participant)}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                              <i class="fas fa-trophy" style="margin-right: 0.5rem; color: ${posColor};"></i>${escapeHtml(winner.program)}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                              <i class="fas fa-graduation-cap" style="margin-right: 0.5rem;"></i>${(escapeHtml(winner.department) || 'N/A').replace('Dep. of ', '')}
                            </div>
                          </div>
                          <div style="text-align: right;">
                            <div style="font-size: 2rem; margin-bottom: 0.25rem;">${posIcon}</div>
                            <div style="font-size: 0.75rem; font-weight: 700; color: ${posColor}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">${winner.position}</div>
                            <div style="font-size: 1.5rem; font-weight: 800; font-family: var(--font-heading); color: var(--accent-color);">${winner.points}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase;">Points</div>
                          </div>
                        </div>
                      </div>
                      `;
            }).join('');
          }

          const popupHtml = `
                      <div id="results-summary-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 12000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; padding: 1rem; box-sizing: border-box;">
                        <div style="background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 700px; max-height: 85vh; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); display: flex; flex-direction: column;">
                          <button onclick="document.getElementById('results-summary-modal').remove()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; z-index: 1;">&times;</button>

                          <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                              <div style="font-size: 2.5rem;">🏆</div>
                              <h2 style="font-family: var(--font-heading); font-size: 1.75rem; margin: 0; color: white;">Prize Winners</h2>
                            </div>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Summary of all winning registrations</p>
                            ${winnersData.length > 0 ? `<div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--accent-color); font-weight: 600;">Total Winners: ${winnersData.length}</div>` : ''}
                          </div>

                          <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; padding-right: 0.5rem;">
                            ${winnersHtml}
                          </div>

                          <button onclick="document.getElementById('results-summary-modal').remove()" style="margin-top: 1.5rem; background: var(--gradient-main); border: none; padding: 0.75rem 2rem; border-radius: 2rem; color: white; font-weight: 700; cursor: pointer; font-size: 0.95rem; transition: transform 0.2s;">
                            Close
                          </button>
                        </div>
                      </div>
                      <style>
                        .winner-item:hover {
                          background: rgba(255,255,255,0.06) !important;
                        transform: translateX(4px);
              }
                      </style>
                      `;

          document.body.insertAdjacentHTML('beforeend', popupHtml);
        };

        window.toggleGroupMembers = function (btn) {
          const container = btn.nextElementSibling;
          const isHidden = container.style.display === 'none';
          const icon = btn.querySelector('.fa-chevron-down') || btn.querySelector('.fa-chevron-up');
          const textSpan = btn.querySelector('span'); // Assuming span inside button for text

          if (isHidden) {
            container.style.display = 'block';
            if (icon) {
              icon.classList.remove('fa-chevron-down');
              icon.classList.add('fa-chevron-up');
            }
            btn.style.borderColor = 'var(--accent-color)';
            btn.style.background = 'rgba(217, 70, 239, 0.1)';
          } else {
            container.style.display = 'none';
            if (icon) {
              icon.classList.remove('fa-chevron-up');
              icon.classList.add('fa-chevron-down');
            }
            btn.style.borderColor = 'rgba(255,255,255,0.1)';
            btn.style.background = 'rgba(255,255,255,0.05)';
          }
        };

        window.toggleRegActions = function (btn) {
          const card = btn.closest('.registration-card');
          const actions = card.querySelector('.reg-card-actions');
          const isShowing = actions.classList.contains('show');

          if (isShowing) {
            actions.classList.remove('show');
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-chevron-down"></i> Contact Student';
          } else {
            actions.classList.add('show');
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Contact Options';
          }
        };

        function loadUserRegistrations() {
          const user = auth.currentUser;
          if (!user) return;

          console.log(`[Diagnostic] Loading registrations. User: ${user.email}, Admin: ${isFirestoreAdmin}, Dept: ${userDepartment}, AllowedCourses: ${userAllowedCourses.length}`);

          const baseColl = collection(db, "registrations");
          let currentUnsubscribe = null;

          // Helper to start the listener with fallback capability
          const startRegistrationListener = (queryToUse, isFallback = false) => {
            // Unsubscribe previous listener if switching queries
            if (currentUnsubscribe) {
              // If we are replacing the global listener, we don't need to call it here as we are about to overwrite it
              // But if we are inside the recursive call, we might want to ensure cleanliness.
              // Actually, onSnapshot returns the unsub function.
            }

            registrationsListener = onSnapshot(queryToUse, (snapshot) => {
              const registrations = [];
              snapshot.forEach((doc) => {
                registrations.push({ id: doc.id, ...doc.data() });
              });

              // Sort by registeredAt date (newest first)
              registrations.sort((a, b) => {
                const dateA = new Date(a.registeredAt || 0);
                const dateB = new Date(b.registeredAt || 0);
                return dateB - dateA;
              });

              console.log(`Found ${registrations.length} registrations${isFallback ? ' (Fallback Mode)' : ''}`);

              // Calculate Counts
              const onStageCount = registrations.filter(r => r.category === "On Stage").length;
              const offStageCount = registrations.filter(r => r.category === "Off Stage").length;

              const countOnStageElem = document.getElementById('count-on-stage');
              const countOffStageElem = document.getElementById('count-off-stage');

              if (countOnStageElem) countOnStageElem.textContent = onStageCount;
              if (countOffStageElem) countOffStageElem.textContent = offStageCount;

              allUserRegistrations = registrations;
              updateItemFilterDropdown(registrations);
              updateCourseFilterDropdown(registrations);
              filterAndDisplayRegistrations();

              if (isFallback) {
                // Optional: Visual indicator could be added here
                const existingToast = document.getElementById('fallback-toast');
                if (!existingToast) {
                  // Simple non-intrusive logging for now, or a checkmark
                }
              }

            }, (error) => {
              console.error("Error loading registrations:", error);

              // FALLBACK LOGIC
              if (error.code === 'permission-denied' && !isFallback) {
                console.warn("Permission denied for primary query. Attempting fallback to Personal Query.");

                const personalQ = query(baseColl,
                  where("academicYear", "==", systemYear),
                  where("registeredBy", "==", user.email),
                  limit(500)
                );
                startRegistrationListener(personalQ, true);
                return;
              }

              if (registrationsContainer) {
                registrationsContainer.innerHTML = `
                  <div class="reg-empty-state">
                    <div class="reg-empty-icon">\u26A0\uFE0F</div>
                    <div class="reg-empty-text">Error loading registrations</div>
                    <div class="reg-empty-subtext">${isFallback ? "Could not load personal registrations." : error.message}</div>
                  </div>
                `;
              }
            });
          };

          // Build Initial Query
          let initialQ;
          if (isFirestoreAdmin) {
            console.log("Query Mode: Admin");
            initialQ = query(baseColl, where("academicYear", "==", systemYear), limit(500));
          } else if (userAllowedCourses && userAllowedCourses.length > 0) {
            console.log("Query Mode: Whitelist (Courses)");
            initialQ = query(baseColl,
              where("academicYear", "==", systemYear),
              where("department", "in", userAllowedCourses),
              limit(500)
            );
          } else if (userDepartment && userDepartment !== "Main Admin" && departmentCourseMap[userDepartment]) {
            console.log("Query Mode: Whitelist (Legacy)");
            initialQ = query(baseColl,
              where("academicYear", "==", systemYear),
              where("department", "in", departmentCourseMap[userDepartment]),
              limit(500)
            );
          } else {
            console.log("Query Mode: Personal (registeredBy)");
            initialQ = query(baseColl,
              where("academicYear", "==", systemYear),
              where("registeredBy", "==", user.email),
              limit(500)
            );
          }

          // Start the listener
          startRegistrationListener(initialQ);


          // Set up real-time listener for achievements (score_logs) filtered by year
          console.log('[Score Logs] Setting up listener for year:', systemYear);
          const scoresQ = query(collection(db, "score_logs"), where("academicYear", "==", systemYear));
          onSnapshot(scoresQ, (snapshot) => {
            allScoreLogs = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              console.log('[Score Logs] Loaded log:', data);
              allScoreLogs.push(data);
            });
            console.log(`[Score Logs] Total loaded: ${allScoreLogs.length} score logs`);
            console.log('[Score Logs] Sample data:', allScoreLogs[0]);
            // Refresh display to show badges if registrations are already loaded
            if (allUserRegistrations.length > 0) {
              console.log('[Score Logs] Refreshing display with', allUserRegistrations.length, 'registrations');
              filterAndDisplayRegistrations();
            }
          }, (error) => {
            console.error("[Score Logs] Error loading score logs:", error);
          });
        }

        // Load registrations when app initializes (AWAITED)
        fetchSystemYear().then(() => {
          loadUserRegistrations();
        });

        // --- PDF Export Logic (Moved) ---

        window.openPDFPreview = () => {
          const btn = document.getElementById('download-pdf-btn');
          const originalContent = btn.innerHTML;

          if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
            btn.disabled = true;
          }

          // 1. Prepare Data (Match logic in filterAndDisplayRegistrations)
          const yearFilter = document.getElementById('filter-reg-year')?.value || 'all';
          const deptFilter = document.getElementById('filter-reg-department')?.value || '';
          const itemFilter = (document.getElementById('filter-reg-item')?.value || '').toLowerCase();
          const dateFilter = document.getElementById('filter-reg-date')?.value || 'all';

          const filteredData = allUserRegistrations.filter(reg => {
            const matchesYear = yearFilter === 'all' || String(reg.year) === String(yearFilter);
            const matchesDept = !deptFilter || reg.department === deptFilter;
            // Check for 'on stage' / 'off stage' category filter which is separate buttons
            const matchesCategory = categoryFilter === 'all' || reg.category === categoryFilter;

            const matchesItem = !itemFilter ||
              (reg.program && reg.program.toLowerCase().includes(itemFilter)) ||
              (reg.studentName && reg.studentName.toLowerCase().includes(itemFilter));

            const regProgramDate = programDates[reg.program]?.date;
            const matchesDate = dateFilter === 'all' ||
              regProgramDate === dateFilter ||
              (regProgramDate && regProgramDate.startsWith(dateFilter + ','));

            return matchesYear && matchesDept && matchesItem && matchesCategory && matchesDate;
          });

          // Sort by Time (AM to PM)
          filteredData.sort((a, b) => {
            const dateTimeA = programDates[a.program]?.date || '';
            const dateTimeB = programDates[b.program]?.date || '';

            if (!dateTimeA && !dateTimeB) return 0;
            if (!dateTimeA) return 1;
            if (!dateTimeB) return -1;

            try {
              // Format usually "Jan 17, 10:00 AM"
              const dateA = new Date(dateTimeA.replace(',', ', 2026'));
              const dateB = new Date(dateTimeB.replace(',', ', 2026'));
              return dateA - dateB;
            } catch (e) {
              return 0;
            }
          });

          // 2. Build PDF Content (Adapted from admin.html)
          // Create wrapper dynamically
          const wrapper = document.createElement('div');
          wrapper.id = 'pdf-content-wrapper';
          wrapper.style.width = '1000px';
          wrapper.style.minHeight = '1414px'; // ~A4 height
          wrapper.style.height = 'auto'; // Ensure it grows
          wrapper.style.padding = '40px';
          wrapper.style.fontFamily = "'Inter', sans-serif";
          wrapper.style.color = '#1e293b';
          wrapper.style.background = '#ffffff';
          wrapper.style.boxSizing = 'border-box';

          const dateStr = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          const logoSrc = "assets/Pazhassiraja_College_Pulpally_Logo.png";

          let filterSummary = [];
          if (categoryFilter !== 'all') filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">${categoryFilter}</span>`);
          if (deptFilter) filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">${deptFilter.replace('Dep. of ', '')}</span>`);
          if (yearFilter !== 'all') filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">${yearFilter}${yearFilter === '1' ? 'st' : yearFilter === '2' ? 'nd' : yearFilter === '3' ? 'rd' : 'th'} Year</span>`);
          if (itemFilter) filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">Filter: ${itemFilter}</span>`);
          if (dateFilter !== 'all') filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">Date: ${dateFilter}</span>`);
          if (!filterSummary.length) filterSummary.push(`<span style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.8rem;">All My Registrations</span>`);


          const html = `
                      <div style="width: 100%;">
                        <style>
                          .pdf-table {width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 1rem; }
                          .pdf-table th, .pdf-table td {border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
                          .pdf-table th {background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
                          .pdf-table tr {page -break-inside: avoid; break-inside: avoid; }
                          .pdf-table thead {display: table-header-group; }
                          .pdf-table tr:nth-child(even) {background: #f8fafc; }
                        </style>

                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; border-bottom: 2px solid #6366f1; padding-bottom: 1.5rem;">
                          <img src="${logoSrc}" style="height: 80px; margin-right: 20px;" alt="Logo">
                            <div style="text-align: left;">
                              <h1 style="margin: 0; color: #1e293b; font-size: 2rem; font-weight: 800; text-transform: uppercase; letter-spacing: -0.02em;">College Union PRC</h1>
                              <h2 style="margin: 5px 0 0 0; color: #64748b; font-size: 1rem; font-weight: 500;">Arts Festival 2026 - My Registration Report</h2>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem;">
                          <div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Active Filters</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">${filterSummary.join('')}</div>
                          </div>
                          <div style="text-align: right;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0px;">Total Records</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;">${filteredData.length}</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">Generated on ${dateStr}</div>
                          </div>
                        </div>

                        <table class="pdf-table">
                          <thead>
                            <tr>
                              <th style="width: 40px;">#</th>
                              <th>Student / Group</th>
                              <th>Department</th>
                              <th>Roll No</th>
                              <th>Year</th>
                              <th>Type</th>
                              <th>Item / Program</th>
                              <th>Venue</th>
                              <th>Date / Time</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${filteredData.map((d, index) => {
            const progDate = programDates[d.program]?.date || '-';
            return `
                  <tr>
                    <td style="color: #64748b;">${index + 1}</td>
                    <td>
                      <div style="font-weight: 600;">
                        ${d.regType === 'Group' ? (d.groupName || d.studentName || '-') : (d.studentName || '-')}
                        ${d.isCanceled ? '<span style="color: #ef4444; font-size: 0.7rem;"> (CANCELED)</span>' : ''}
                      </div>
                      ${d.regType === 'Group' && d.studentName && d.groupName ? `<div style="font-size: 0.7rem; color: #6366f1;">Leader: ${d.studentName}</div>` : ''}
                    </td>
                    <td>${(d.department || '-').replace('Dep. of ', '')}</td>
                    <td style="font-family: monospace;">${d.rollNumber || '-'}</td>
                    <td>${d.year || '-'}</td>
                    <td>${d.regType || 'Individual'}</td>
                    <td>${d.program || '-'}</td>
                    <td>${programDates[d.program]?.stage || '-'}</td>
                    <td style="font-size: 0.8rem;">${progDate}</td>
                  </tr>
                `;
          }).join('')}
                          </tbody>
                        </table>

                        <div style="margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; display: flex; justify-content: space-between; font-size: 0.75rem; color: #94a3b8;">
                          <span>Pazhassiraja College Pulpally - Official Registration Portal</span>
                          <span>Generated by ${auth.currentUser?.displayName || auth.currentUser?.email || 'User'}</span>
                        </div>
                      </div >
                      `;

          wrapper.innerHTML = html;

          // Inject into Preview Container
          const container = document.getElementById('pdf-preview-container');
          container.innerHTML = '';
          container.appendChild(wrapper);

          // Show Modal
          const modal = document.getElementById('pdf-preview-modal');
          modal.style.display = 'flex';
          modal.classList.remove('hidden'); // Ensure hidden class is removed

          if (btn) {
            btn.innerHTML = originalContent;
            btn.disabled = false;
          }
        };

        window.closePDFPreview = () => {
          const modal = document.getElementById('pdf-preview-modal');
          modal.style.display = 'none';
          modal.classList.add('hidden');
          const container = document.getElementById('pdf-preview-container');
          if (container) container.innerHTML = '';
        };

        window.processPDFDownload = () => {
          // Find the wrapper inside the container
          const wrapper = document.getElementById('pdf-content-wrapper');
          // Target the new download button ID
          const btn = document.getElementById('download-pdf-confirm-btn');
          const originalText = btn.innerHTML;

          if (!wrapper) {
            showCustomAlert("Wait!", "No content to download.", "warning");
            return;
          }

          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
          btn.disabled = true;

          const dateStr = new Date().toISOString().split('T')[0];
          const filename = `PRC_My_Registrations_${dateStr}.pdf`;

          const opt = {
            margin: 10,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
            pagebreak: { mode: ['css', 'legacy'] }
          };

          html2pdf().from(wrapper).set(opt).save().then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i> Done';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 2000);
          }).catch(err => {
            console.error("PDF Export Error:", err);
            showCustomAlert("Oops!", "Error generating PDF. Please try again.", "warning");
            btn.innerHTML = originalText;
            btn.disabled = false;
          });
        };



      } catch (err) {
        console.error("Init Error:", err);
      }
    }

    // initApp is now called from handleAuthChange based on authorization

    // Back to Top Logic
    const backToTopBtn = document.getElementById('back-to-top');
    if (backToTopBtn) {
      window.addEventListener('scroll', () => {
        if (window.scrollY > 400) {
          backToTopBtn.classList.add('visible');
        } else {
          backToTopBtn.classList.remove('visible');
        }
      });

      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }
  </script>
  <!-- Theme Decorations -->
  <!-- Toran border removed -->
  <svg class="mandala-decoration mandala-top-right" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="0.5" fill="none" />
    <circle cx="50" cy="50" r="30" stroke="currentColor" stroke-width="0.5" fill="none" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(0 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(45 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(90 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(135 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(180 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(225 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(270 50 50)" />
    <path d="M50 10 Q60 10 60 20 T50 30 T40 20 T50 10" transform="rotate(315 50 50)" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(45 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(90 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(135 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(180 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(225 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(270 50 50)" fill="currentColor" opacity="0.5" />
    <path d="M50 5 L55 25 L50 45 L45 25 Z" transform="rotate(315 50 50)" fill="currentColor" opacity="0.5" />
  </svg>
  <svg class="mandala-decoration mandala-bottom-left" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="0.5" stroke-dasharray="2 2" fill="none" />
    <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="1" fill="none" />
    <rect x="48" y="0" width="4" height="100" fill="currentColor" opacity="0.2" transform="rotate(45 50 50)" />
    <rect x="48" y="0" width="4" height="100" fill="currentColor" opacity="0.2" transform="rotate(-45 50 50)" />
    <circle cx="50" cy="50" r="10" fill="currentColor" opacity="0.3" />
  </svg>
  <svg class="mandala-decoration mandala-top-left" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="0.5" fill="none" />
    <path d="M50 10 L60 50 L50 90 L40 50 Z" fill="currentColor" opacity="0.4" />
    <path d="M10 50 L50 60 L90 50 L50 40 Z" fill="currentColor" opacity="0.4" />
    <circle cx="50" cy="50" r="10" fill="none" stroke="currentColor" />
  </svg>
  <svg class="mandala-decoration mandala-center-right" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="0.5" stroke-dasharray="4 2" fill="none" />
    <path d="M 50 5 Q 65 35 95 50 Q 65 65 50 95 Q 35 65 5 50 Q 35 35 50 5 Z" fill="currentColor" opacity="0.3" />
    <circle cx="50" cy="50" r="15" fill="currentColor" opacity="0.2" />
  </svg>
  <svg class="mandala-decoration mandala-bottom-center" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="0.2" fill="none" />
    <path d="M50 0 L60 40 L100 50 L60 60 L50 100 L40 60 L0 50 L40 40 Z" fill="currentColor" opacity="0.2" />
    <circle cx="50" cy="50" r="20" stroke="currentColor" stroke-width="1" fill="none" />
  </svg>
  <!-- System Notifications -->
  <div id="network-status-bar">
    <i class="fas fa-exclamation-triangle"></i> Network connection is unstable. Registration may fail.
  </div>
  <div id="system-notifications"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const uiFirebaseConfig = {
      apiKey: "AIzaSyCrjARB6MTC5s_sMPHzf3a1yW1ajHTKHU4",
      authDomain: "unionartsprc.firebaseapp.com",
      databaseURL: "https://unionartsprc-default-rtdb.firebaseio.com",
      projectId: "unionartsprc",
      storageBucket: "unionartsprc.firebasestorage.app",
      messagingSenderId: "812219989202",
      appId: "1:812219989202:web:cb94548572e7dcb5cc810b",
      measurementId: "G-WR8DBND5YD"
    };

    // Use a secondary app name to avoid conflicts if the main app is already initialized
    const app2 = initializeApp(uiFirebaseConfig, "UI_Config_App");
    const db2 = getFirestore(app2);

    async function applyArtsIdentity() {
      try {
        const docRef = doc(db2, "system_config", "ui_identity");
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          const artsName = data.artsName;
          const font = data.fontFamily;

          if (artsName) {
            const titleEl = document.querySelector('h1.logo-title');
            if (titleEl) {
              titleEl.textContent = artsName;
              if (font) {
                // Extract font family name (e.g., "'Rozha One', serif" -> "Rozha One")
                const fontFamily = font.split(',')[0].replace(/['"]/g, '').trim();
                titleEl.style.fontFamily = `"${fontFamily}", serif`; // Apply with fallback

                // If it's a sans-serif font selected, ensure fallback is sans-serif
                if (font.includes('sans-serif')) {
                  titleEl.style.fontFamily = `"${fontFamily}", sans-serif`;
                }
              }
            }
          }
        }
      } catch (error) {
        console.error("Error applying Arts Identity:", error);
      }
    }

    // Call applyArtsIdentity with error handling to prevent unhandled promise rejections
    applyArtsIdentity().catch(err => {
      // Silently fail - UI identity is a non-critical feature
      console.log("UI identity not configured or failed to load:", err.message);
    });
  </script>
</body>

</html>